<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026 åº—å‹™ç³»çµ± - çµ‚æ¥µå‹•æ…‹ç‰ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { 
      --bg-color: #121212; --text-color: #ffffff; --accent-color: #bb86fc;
      --card-bg: rgba(255,255,255,0.08); --input-bg: rgba(255,255,255,0.12);
      --hint: #03dac6; --danger: #ff5252;
    }
    body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; padding-bottom: 90px; transition: 0.3s; }
    .light-theme { --bg-color: #f8f9fa; --text-color: #212529; --accent-color: #6200ee; --card-bg: #ffffff; --input-bg: #e9ecef; }
    
    #login-overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .mobile-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin: 10px 15px; border-left: 4px solid var(--accent-color); position: relative; }
    .card-date { font-weight: bold; color: var(--accent-color); display: flex; justify-content: space-between; cursor: pointer; align-items: center; }
    .form-label { font-size: 0.8rem; color: #aaa; margin-bottom: 2px; font-weight: bold; display: block; }
    .light-theme .form-label { color: #666; }
    .form-control-mobile { background: var(--input-bg) !important; border: 1px solid #555 !important; color: var(--text-color) !important; border-radius: 6px; padding: 6px; font-size: 0.9rem; }
    .light-theme .form-control-mobile { border: 1px solid #ccc !important; }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(0,0,0,0.95); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
    .light-theme .bottom-nav { background: #fff; border-top: 1px solid #ccc; }
    .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 0.7rem; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--accent-color); font-weight: bold; }
    .nav-item i { display: block; font-size: 1.2rem; font-style: normal; margin-bottom: 2px; }
    
    .page-content { display: none; padding-top: 10px; }
    .page-content.active { display: block; }
    .sync-status { position: fixed; top: 10px; right: 10px; padding: 4px 12px; border-radius: 20px; font-size: 12px; z-index: 10001; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .boss-mode-blur .report-val { filter: blur(10px); }
    .today-tag { background: var(--hint); color: #000; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: bold; }
    .month-selector { background: var(--card-bg); margin: 0 15px 15px 15px; padding: 12px; border-radius: 12px; border: 1px solid var(--accent-color); display: flex; align-items: center; justify-content: space-between; }
    
    /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
    .btn-del-item { position: absolute; right: 10px; top: 10px; font-size: 0.8rem; color: var(--danger); border: 1px solid var(--danger); background: transparent; border-radius: 5px; }
  </style>
</head>
<body>

<div id="sync-indicator" class="sync-status text-white" style="display:none; background: var(--hint);"></div>

<div id="login-overlay">
  <div class="p-4 w-100" style="max-width: 350px;">
    <h3 class="text-center mb-4" style="color: var(--accent-color);">2026 åº—å‹™ç³»çµ±</h3>
    <select id="user-select" class="form-select form-control-mobile mb-3"></select>
    <input type="password" id="login-pwd" class="form-control-mobile form-control mb-4" placeholder="å¯†ç¢¼">
    <button class="btn btn-primary w-100 py-2" onclick="authLogin()" style="background:var(--accent-color); border:none;">ç¢ºèªç™»å…¥</button>
  </div>
</div>

<div id="app" style="display:none;">
  
  <div id="pageA" class="page-content active">
    <div class="month-selector">
        <span style="font-weight:bold;">ğŸ“… å ±è¡¨æœˆä»½</span>
        <input type="month" id="global-month" class="form-control-mobile" style="width: 140px;" onchange="changeMonth()">
    </div>
    <h5 class="text-center mb-3">A. æ¯æ—¥ç‡Ÿæ”¶</h5>
    <div id="listA"></div>
  </div>

  <div id="pageB" class="page-content">
    <h5 class="text-center mb-3">B. é›¶ç”¨é‡‘æ”¯å‡º</h5>
    <div class="mobile-card">
        <label>ä¸Šæœˆé›¶ç”¨é¤˜é¡:</label> 
        <input type="number" id="prevPetty" class="form-control-mobile d-inline-block w-50 ms-2" onchange="saveSystem()">
    </div>
    <div id="listB"></div>
  </div>

  <div id="pageC" class="page-content">
    <h5 class="text-center mb-3">C. éŠ€è¡Œæ”¶æ”¯</h5>
    <div class="mobile-card">
        <label>ä¸ŠæœˆéŠ€è¡Œé¤˜é¡:</label> 
        <input type="number" id="prevBank" class="form-control-mobile d-inline-block w-50 ms-2" onchange="saveSystem()">
    </div>
    <div id="listC"></div>
  </div>

  <div id="pageD" class="page-content">
    <h5 class="text-center mb-3">D. å» å•†æœˆçµé€²è²¨</h5>
    <div id="listD"></div>
  </div>

  <div id="pageE" class="page-content">
    <h5 class="text-center mb-3">E. æœˆåº¦æç›Šå ±è¡¨ <button class="btn btn-sm btn-outline-secondary" onclick="toggleBossMode()">ğŸ‘ï¸</button></h5>
    <div class="mobile-card">
        <label>æˆ¿ç§Ÿæ”¯å‡º:</label> 
        <input type="number" id="rentInput" class="form-control-mobile d-inline-block w-50 ms-2" onchange="saveSystem()">
    </div>
    <div id="reportArea"></div>
  </div>

  <div id="pageF" class="page-content">
    <h5 class="text-center text-danger">F. å¾Œå°è¨­å®š</h5>
    <div class="px-3" id="config-ui">
        <div class="mobile-card">
            <h6>1. è¦–è¦ºä¸»é¡Œ</h6>
            <div class="d-flex gap-2 mb-2">
                <button class="btn btn-sm btn-dark flex-fill" onclick="setTheme('dark')">æ·±è‰²</button>
                <button class="btn btn-sm btn-light flex-fill" onclick="setTheme('light')">æ·ºè‰²</button>
            </div>
            <label class="form-label">æ¨¡çµ„é¡è‰²</label>
            <input type="color" id="accentColorPicker" class="form-control mb-2" onchange="setAccent(this.value)">
        </div>

        <div class="mobile-card">
            <h6>2. Aé  æ”¯ä»˜æ–¹å¼</h6>
            <div id="cfg-list-pay"></div>
            <div class="input-group mt-2">
                <input type="text" id="new-pay-name" class="form-control form-control-sm" placeholder="åç¨±">
                <input type="number" id="new-pay-pct" class="form-control form-control-sm" placeholder="%" step="0.01">
                <button class="btn btn-sm btn-info" onclick="addItem('pay')">æ–°å¢</button>
            </div>
        </div>

        <div class="mobile-card">
            <h6>3. Bé  æ”¯å‡ºé¡åˆ¥ (é€£å‹•Eè¡¨)</h6>
            <div id="cfg-list-b"></div>
            <div class="input-group mt-2">
                <input type="text" id="new-b-name" class="form-control form-control-sm" placeholder="åç¨±">
                <select id="new-b-type" class="form-select form-select-sm">
                    <option value="food">é£Ÿææˆæœ¬</option>
                    <option value="alc">é…’æ°´æˆæœ¬</option>
                    <option value="hr">äººäº‹æˆæœ¬</option>
                    <option value="misc">é›œæ”¯/ç‡Ÿé‹</option>
                </select>
                <button class="btn btn-sm btn-info" onclick="addItem('catsB')">æ–°å¢</button>
            </div>
        </div>

        <div class="mobile-card">
            <h6>4. Cé  éŠ€è¡Œé¡åˆ¥ (é€£å‹•Eè¡¨)</h6>
            <div id="cfg-list-c"></div>
            <div class="input-group mt-2">
                <input type="text" id="new-c-name" class="form-control form-control-sm" placeholder="åç¨±">
                <select id="new-c-type" class="form-select form-select-sm">
                    <option value="income">æ”¶å…¥(ä¸è¨ˆæ”¯)</option>
                    <option value="food">é£Ÿææˆæœ¬</option>
                    <option value="alc">é…’æ°´æˆæœ¬</option>
                    <option value="hr">äººäº‹æˆæœ¬</option>
                    <option value="misc">é›œæ”¯/ç‡Ÿé‹</option>
                </select>
                <button class="btn btn-sm btn-info" onclick="addItem('catsC')">æ–°å¢</button>
            </div>
        </div>

        <div class="mobile-card">
            <h6>5. Dé  å» å•†æ¸…å–® (é€£å‹•Eè¡¨)</h6>
            <div id="cfg-list-d"></div>
            <div class="input-group mt-2">
                <input type="text" id="new-d-name" class="form-control form-control-sm" placeholder="åç¨±">
                <select id="new-d-type" class="form-select form-select-sm">
                    <option value="food">é£Ÿææˆæœ¬</option>
                    <option value="alc">é…’æ°´æˆæœ¬</option>
                    <option value="misc">é›œè²¨æˆæœ¬</option>
                </select>
                <button class="btn btn-sm btn-info" onclick="addItem('catsD')">æ–°å¢</button>
            </div>
        </div>

        <button class="btn btn-danger w-100 mt-4 py-3 fw-bold" onclick="saveFullConfig()">å„²å­˜æ‰€æœ‰è¨­å®šä¸¦é‡æ•´</button>
    </div>
  </div>

  <div id="pageG" class="page-content">
    <h5 class="text-center text-danger">G. ä½¿ç”¨è€…ç®¡ç†</h5>
    <div class="px-3">
        <div class="mobile-card">
            <h6>ä½¿ç”¨è€…åˆ—è¡¨</h6>
            <div id="user-manage-list"></div>
        </div>
        <div class="mobile-card mt-3">
            <h6>æ–°å¢ä½¿ç”¨è€… (éœ€å¯†ç¢¼)</h6>
            <input type="text" id="new-u-name" class="form-control-mobile w-100 mb-2" placeholder="å¸³è™Ÿ">
            <input type="password" id="new-u-pwd" class="form-control-mobile w-100 mb-2" placeholder="å¯†ç¢¼">
            <input type="text" id="new-u-safe" class="form-control-mobile w-100 mb-2" placeholder="å®‰å…¨å•é¡Œ">
            <label class="form-label">æ¬Šé™ç­‰ç´š</label>
            <select id="new-u-role" class="form-control-mobile w-100 mb-3">
                <option value="admin">ç®¡ç†è€… (ç„¡å¾Œå°)</option>
                <option value="staff">å“¡å·¥ (åƒ…æ“ä½œ)</option>
            </select>
            <button class="btn btn-success w-100" onclick="addUser()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showPage('A')" id="nav-A"><i>ğŸ“Š</i>ç‡Ÿæ”¶</div>
    <div class="nav-item" onclick="showPage('B')" id="nav-B"><i>ğŸ’¸</i>æ”¯å‡º</div>
    <div class="nav-item" onclick="showPage('C')" id="nav-C"><i>ğŸ¦</i>éŠ€è¡Œ</div>
    <div class="nav-item" onclick="showPage('D')" id="nav-D"><i>ğŸšš</i>é€²è²¨</div>
    <div class="nav-item" onclick="showPage('E')" id="nav-E"><i>ğŸ“ˆ</i>å ±è¡¨</div>
    <div class="nav-item admin-btn" style="display:none" onclick="showPage('F')" id="nav-F"><i>âš™ï¸</i>å¾Œå°</div>
    <div class="nav-item admin-btn" style="display:none" onclick="showPage('G')" id="nav-G"><i>ğŸ‘¤</i>æ¬Šé™</div>
  </nav>
</div>

<script>
// --- 1. åˆå§‹è¨­å®šèˆ‡è³‡æ–™çµæ§‹ ---
// é€™è£¡åŒ…å«äº†æ‰€æœ‰é è¨­å€¼ï¼Œç¢ºä¿ã€Œä¸ç²¾ç°¡ã€åŸæœ¬è¨­å®š
const DEFAULT_CONFIG = {
    theme: 'dark', 
    accent: '#bb86fc',
    pay: [
        {name:'ä¿¡ç”¨å¡', pct:0.98}, {name:'å…¨æ”¯ä»˜', pct:0.98}, {name:'UBER', pct:0.65}
    ],
    catsB: [ // type: food, alc, hr, misc
        {name:'é£Ÿå“æ”¯å‡º', type:'food'}, {name:'é…’é¡æ”¯å‡º', type:'alc'}, 
        {name:'å¤–å¸¶é¤ç›’', type:'misc'}, {name:'å…¶é¤˜é›œæ”¯', type:'misc'},
        {name:'å‹å¥ä¿', type:'hr'}, {name:'PT', type:'hr'},
        {name:'é›»ä¿¡', type:'misc'}, {name:'é›»è²»', type:'misc'}, 
        {name:'æ°´è²»', type:'misc'}, {name:'ç“¦æ–¯', type:'misc'}
    ],
    catsC: [ // type: income, food, alc, hr, misc
        {name:'å…¨æ”¯ä»˜æ”¶å…¥', type:'income'}, {name:'ä¿¡ç”¨å¡æ”¶å…¥', type:'income'}, 
        {name:'UBERæ”¶å…¥', type:'income'}, {name:'å…¶é¤˜æ”¶å…¥', type:'income'},
        {name:'é£Ÿå“æ”¯å‡º', type:'food'}, {name:'é…’é¡æ”¯å‡º', type:'alc'},
        {name:'é›œæ”¯æ¬¾', type:'misc'}, {name:'äººäº‹æ¬¾', type:'hr'}
    ],
    catsD: [ // type: food, alc, misc
        {name:'èœå•†', type:'food'}, {name:'æµ·é®®å•†', type:'food'}, 
        {name:'è‚‰å•†', type:'food'}, {name:'é…’å•†', type:'alc'}, {name:'é›œè²¨å•†', type:'misc'}
    ]
};

let sysConfig = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); // Deep copy
let users = [{user:'siang', pwd:'1234', role:'siang', safe:'æœ€é«˜æ¬Šé™'}]; // é è¨­æœ€é«˜æ¬Šé™
let currentUser = null;

const SB_URL = "https://jxtjkjexnqfhxmwfgcgl.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4dGpramV4bnFmaHhtd2ZnY2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTA4ODEsImV4cCI6MjA4NjM2Njg4MX0.Ebw_qhA3Z_p_tB_EwxWmvC0z3oC9MisDQm6DEuGkno0";
const db = supabase.createClient(SB_URL, SB_KEY);

// --- 2. å•Ÿå‹•èˆ‡ç™»å…¥ ---
window.onload = async () => {
    const now = new Date();
    document.getElementById('global-month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    
    // é †åºï¼šè¼‰å…¥ä½¿ç”¨è€… -> è¼‰å…¥è¨­å®š -> æ¸²æŸ“ç™»å…¥é¸å–®
    await loadUsers();
    await loadConfig(); 
    renderUserSelect();
};

async function authLogin() {
    const u = document.getElementById('user-select').value;
    const p = document.getElementById('login-pwd').value;
    const found = users.find(x => x.user === u && x.pwd === p);
    
    if(found) {
        currentUser = found;
        document.getElementById('login-overlay').style.display='none';
        document.getElementById('app').style.display='block';
        applyPermissions(found.role);
        initApp();
    } else { 
        alert("å¯†ç¢¼éŒ¯èª¤"); 
    }
}

function applyPermissions(role) {
    // é è¨­å…¨éƒ¨éš±è—
    const els = ['nav-E', 'nav-F', 'nav-G'];
    els.forEach(id => document.getElementById(id).style.display = 'none');
    
    // siang: çœ‹å…¨éƒ¨
    if(role === 'siang') {
        els.forEach(id => document.getElementById(id).style.display = 'block');
    }
    // admin (ç®¡ç†è€…): çœ‹ä¸åˆ° F, G
    else if(role === 'admin') {
        document.getElementById('nav-E').style.display = 'block';
    }
    // staff (å“¡å·¥): çœ‹ä¸åˆ° E, F, G (åªå‰©ä¸‹ A, B, C, D)
}

function initApp() {
    renderPages();
    loadDailyData();
    updateTheme();
}

function changeMonth() {
    renderPages();
    loadDailyData();
}

// --- 3. é é¢ç”Ÿæˆ (å…¨å‹•æ…‹ + æ”¶æ‘º) ---
function renderPages() {
    const monthStr = document.getElementById('global-month').value;
    const [y, m] = monthStr.split('-').map(Number);
    const daysInMonth = new Date(y, m, 0).getDate();
    const today = new Date();
    const isThisMonth = (y === today.getFullYear() && m === (today.getMonth()+1));
    const todayD = today.getDate();

    const build = (id, title, htmlFn) => {
        let h = '';
        for(let d=1; d<=daysInMonth; d++) {
            const isToday = (isThisMonth && d === todayD);
            h += `<div class="mobile-card">
                <div class="card-date" onclick="toggle('${id}',${d})">
                    <span>${monthStr}/${d} ${title} ${isToday?'<span class="today-tag">ä»Šæ—¥</span>':''}</span>
                    <span id="arr-${id}-${d}">${isToday?'â–²':'â–¼'}</span>
                </div>
                <div id="box-${id}-${d}" style="display:${isToday?'block':'none'}; margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    ${htmlFn(d)}
                </div>
            </div>`;
        }
        document.getElementById('list'+id).innerHTML = h;
    };

    // A é  (Pay ä¾æ“šè¨­å®š)
    build('A', 'ç‡Ÿæ”¶', (d) => `
        <div class="row g-2">
            <div class="col-6"><label class="form-label">ç¾é‡‘</label><input type="number" id="cash-${d}" class="form-control-mobile w-100" value="6000" onchange="sync(${d})"></div>
            <div class="col-6"><label class="form-label">åº•éŒ¢</label><input type="number" id="reg-${d}" class="form-control-mobile w-100" value="6000" onchange="sync(${d})"></div>
            ${sysConfig.pay.map((p,i) => `<div class="col-4"><label class="form-label">${p.name}</label><input type="number" id="pay-${i}-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
            <div class="col-6"><label class="form-label text-warning">é…’æ°´ç‡Ÿæ”¶</label><input type="number" id="alc-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
            <div class="col-4"><label class="form-label">å…¥éŠ€è¡Œ</label><input type="number" id="abank-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
            <div class="col-4"><label class="form-label">å…¥é›¶ç”¨</label><input type="number" id="apetty-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
            <div class="col-12 text-end mt-1">æ­£è² é›¶: <b id="diff-${d}">0</b></div>
        </div>`);

    // B é  (å‹•æ…‹é¡åˆ¥)
    build('B', 'æ”¯å‡º', (d) => `<div class="row g-2">
        ${sysConfig.catsB.map((c,i) => `<div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="b-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
    </div>`);

    // C é  (å‹•æ…‹é¡åˆ¥)
    build('C', 'éŠ€è¡Œ', (d) => `<div class="row g-2">
        ${sysConfig.catsC.map((c,i) => `<div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="c-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
    </div>`);

    // D é  (å‹•æ…‹é¡åˆ¥)
    build('D', 'é€²è²¨', (d) => `<div class="row g-2">
        ${sysConfig.catsD.map((c,i) => `<div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="d-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
    </div>`);
}

// --- 4. è³‡æ–™å„²å­˜èˆ‡åŒæ­¥ (ä¿®å¾©å„²å­˜å•é¡Œ) ---
async function sync(d) {
    const monthKey = document.getElementById('global-month').value;
    const ind = document.getElementById('sync-indicator');
    ind.style.display = 'block'; ind.innerText = "â³ å„²å­˜ä¸­..."; ind.style.background = "#555";

    // æŠ“å–å„é é¢è³‡æ–™ (è™•ç†å‹•æ…‹é•·åº¦)
    const getVals = (prefix, arr) => arr.map((_, i) => val(`${prefix}-${d}-${i}`));

    const data = {
        date_key: `${monthKey}-${d.toString().padStart(2,'0')}`,
        cash: val(`cash-${d}`),
        reg_val: val(`reg-${d}`),
        alc_val: val(`alc-${d}`),
        bank_in: val(`abank-${d}`),
        petty_in: val(`apetty-${d}`),
        pay_vals: getVals('pay', sysConfig.pay),
        b_vals: getVals('b-v', sysConfig.catsB),
        c_vals: getVals('c-v', sysConfig.catsC),
        d_vals: getVals('d-v', sysConfig.catsD)
    };

    try {
        const { error } = await db.from('daily_data').upsert(data);
        if(error) throw error;
        ind.innerText = "âœ“ å·²å„²å­˜"; ind.style.background = "var(--hint)";
        setTimeout(() => ind.style.display='none', 1500);
        calcAll();
    } catch(e) {
        ind.innerText = "âœ— å¤±æ•—"; ind.style.background = "var(--danger)";
        alert("å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ Supabase è³‡æ–™åº«æ¬„ä½æ˜¯å¦è¶³å¤ ã€‚\néŒ¯èª¤: " + e.message);
    }
}

async function loadDailyData() {
    // æ¸…ç©º
    document.querySelectorAll('input[type="number"]').forEach(el => {
        if(!el.id.includes('prev') && el.id!=='rentInput') el.value = '';
    });

    const monthKey = document.getElementById('global-month').value;
    
    // è¼‰å…¥ System
    const sys = await db.from('daily_data').select('*').eq('date_key', `SYS-${monthKey}`).maybeSingle();
    if(sys.data) {
        document.getElementById('prevPetty').value = sys.data.cash;
        document.getElementById('prevBank').value = sys.data.bank_in;
        document.getElementById('rentInput').value = sys.data.reg_val;
    } else {
        document.getElementById('prevPetty').value = 0;
        document.getElementById('prevBank').value = 0;
        document.getElementById('rentInput').value = 0;
    }

    // è¼‰å…¥ Daily
    const { data } = await db.from('daily_data').select('*').like('date_key', `${monthKey}%`);
    if(data) {
        data.forEach(row => {
            const d = parseInt(row.date_key.split('-')[2]);
            if(!document.getElementById(`cash-${d}`)) return;

            document.getElementById(`cash-${d}`).value = row.cash || 6000;
            document.getElementById(`reg-${d}`).value = row.reg_val || 6000;
            document.getElementById(`alc-${d}`).value = row.alc_val || 0;
            document.getElementById(`abank-${d}`).value = row.bank_in || 0;
            document.getElementById(`apetty-${d}`).value = row.petty_in || 0;

            // å¡«å›é™£åˆ—è³‡æ–™ (å®‰å…¨æª¢æŸ¥é•·åº¦)
            const fill = (prefix, vals) => {
                if(vals && Array.isArray(vals)) {
                    vals.forEach((v, i) => {
                        const el = document.getElementById(`${prefix}-${d}-${i}`);
                        if(el) el.value = v;
                    });
                }
            };
            fill('pay', row.pay_vals);
            fill('b-v', row.b_vals);
            fill('c-v', row.c_vals);
            fill('d-v', row.d_vals);
        });
    }
    calcAll();
}

async function saveSystem() {
    const monthKey = document.getElementById('global-month').value;
    await db.from('daily_data').upsert({
        date_key: `SYS-${monthKey}`,
        cash: val('prevPetty'), bank_in: val('prevBank'), reg_val: val('rentInput')
    });
    calcAll();
}

// --- 5. å ±è¡¨è¨ˆç®— (é€£å‹•é¡åˆ¥è¨­å®š) ---
function calcAll() {
    const monthStr = document.getElementById('global-month').value;
    const [y, m] = monthStr.split('-').map(Number);
    const days = new Date(y, m, 0).getDate();

    let tRev=0, tAlcRev=0, tFoodRev=0;
    let costF=0, costA=0, costM=0, costHR=0;

    for(let d=1; d<=days; d++) {
        // A é 
        let dPay = 0; 
        sysConfig.pay.forEach((p,i) => dPay += (val(`pay-${i}-${d}`) * p.pct));
        tRev += (val(`cash-${d}`) + dPay - val(`reg-${d}`));
        tAlcRev += val(`alc-${d}`);
        
        // æ­£è² é›¶
        let diff = Math.round((val(`cash-${d}`) - val(`reg-${d}`)) - (val(`abank-${d}`) + val(`apetty-${d}`)));
        const de = document.getElementById(`diff-${d}`);
        if(de) { de.innerText = diff; de.style.color = (diff===0)?'var(--hint)':'var(--danger)'; }

        // B, C, D é  (æ ¹æ“š config çš„ type ä¾†ç´¯åŠ )
        const sumCat = (prefix, cats) => {
            cats.forEach((c, i) => {
                const v = val(`${prefix}-${d}-${i}`);
                if(c.type === 'food') costF += v;
                else if(c.type === 'alc') costA += v;
                else if(c.type === 'hr') costHR += v;
                else if(c.type === 'misc') costM += v;
                // income é¡åˆ¥ä¸è¨ˆå…¥æˆæœ¬
            });
        };
        sumCat('b-v', sysConfig.catsB);
        sumCat('c-v', sysConfig.catsC);
        sumCat('d-v', sysConfig.catsD);
    }

    tFoodRev = tRev - tAlcRev;
    const rent = val('rentInput');
    const totalCostFood = costF + costA;
    const totalExp = totalCostFood + costM + costHR + rent;
    const profit = tRev - totalExp;
    const pct = (a, b) => b===0 ? 0 : ((a/b)*100).toFixed(1);

    document.getElementById('reportArea').innerHTML = `
        <div class="row g-2 boss-mode-blur mt-2">
            <div class="col-12"><div class="mobile-card text-center" style="background:var(--accent-color); color:#000;">
                <h6>æœ¬æœˆç²åˆ©</h6><h2 class="report-val" style="font-weight:900">${Math.round(profit).toLocaleString()}</h2>
            </div></div>
            <div class="col-6"><div class="mobile-card">ç¸½ç‡Ÿæ¥­é¡<br><b class="report-val">${Math.round(tRev).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">ç¸½æ”¯å‡º<br><b class="report-val text-danger">${Math.round(totalExp).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é£Ÿææˆæœ¬ (${pct(costF, tFoodRev)}%)<br><b class="report-val">${Math.round(costF).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é…’æ°´æˆæœ¬ (${pct(costA, tAlcRev)}%)<br><b class="report-val">${Math.round(costA).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">ç¸½é£Ÿææˆæœ¬ (${pct(totalCostFood, tRev)}%)<br><b class="report-val">${Math.round(totalCostFood).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">äººäº‹æˆæœ¬<br><b class="report-val">${Math.round(costHR).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é›œæ”¯ç¸½é¡<br><b class="report-val">${Math.round(costM).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">æˆ¿ç§Ÿ<br><b class="report-val">${rent.toLocaleString()}</b></div></div>
        </div>`;
}

// --- 6. å¾Œå°ç®¡ç† (Fé ) ---
function renderConfigUI() {
    // æ¸²æŸ“ A é åˆ—è¡¨
    document.getElementById('cfg-list-pay').innerHTML = sysConfig.pay.map((p,i) => 
        `<div class="d-flex justify-content-between mb-1 border-bottom pb-1">
            <span>${p.name} (${p.pct})</span> <button class="btn btn-sm text-danger" onclick="delItem('pay',${i})">âœ•</button>
         </div>`).join('');
         
    // æ¸²æŸ“ B, C, D é åˆ—è¡¨ (é¡¯ç¤ºåç¨±èˆ‡é¡å‹)
    const renderList = (id, list, key) => {
        document.getElementById(id).innerHTML = list.map((c,i) => {
            let typeName = c.type==='food'?'é£Ÿæ':(c.type==='alc'?'é…’æ°´':(c.type==='hr'?'äººäº‹':(c.type==='income'?'æ”¶å…¥':'é›œæ”¯')));
            return `<div class="d-flex justify-content-between mb-1 border-bottom pb-1">
                <span>${c.name} <small class="text-muted">[${typeName}]</small></span> 
                <button class="btn btn-sm text-danger" onclick="delItem('${key}',${i})">âœ•</button>
            </div>`;
        }).join('');
    };
    renderList('cfg-list-b', sysConfig.catsB, 'catsB');
    renderList('cfg-list-c', sysConfig.catsC, 'catsC');
    renderList('cfg-list-d', sysConfig.catsD, 'catsD');
    
    // é¡è‰²è¨­å®š
    document.getElementById('accentColorPicker').value = sysConfig.accent;
}

function addItem(key) {
    if(key === 'pay') {
        const n = document.getElementById('new-pay-name').value;
        const p = parseFloat(document.getElementById('new-pay-pct').value);
        if(!n || isNaN(p)) return alert("è«‹è¼¸å…¥åç¨±èˆ‡æ•¸å€¼");
        sysConfig.pay.push({name:n, pct:p});
    } else { // catsB, catsC, catsD
        const map = {catsB:'new-b', catsC:'new-c', catsD:'new-d'};
        const n = document.getElementById(map[key]+'-name').value;
        const t = document.getElementById(map[key]+'-type').value;
        if(!n) return alert("è«‹è¼¸å…¥åç¨±");
        sysConfig[key].push({name:n, type:t});
    }
    renderConfigUI();
}

function delItem(key, idx) {
    if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿé€™å¯èƒ½æœƒå°è‡´èˆŠå ±è¡¨å°æ‡‰éŒ¯èª¤ã€‚")) return;
    sysConfig[key].splice(idx, 1);
    renderConfigUI();
}

async function saveFullConfig() {
    if(currentUser.role !== 'siang') return alert("æ¬Šé™ä¸è¶³");
    await db.from('daily_data').upsert({date_key: 'CONFIG', memo_text: JSON.stringify(sysConfig)});
    alert("è¨­å®šå·²å„²å­˜ï¼Œç¶²é å°‡é‡æ–°æ•´ç†");
    location.reload();
}

// --- 7. ä½¿ç”¨è€…ç®¡ç† (Gé ) ---
function renderUserUI() {
    document.getElementById('user-manage-list').innerHTML = users.map((u,i) => `
        <div class="mobile-card d-flex justify-content-between align-items-center">
            <div>
                <b>${u.user}</b> <span class="badge bg-secondary">${u.role}</span><br>
                <small>å®‰å…¨: ${u.safe}</small>
            </div>
            ${u.role!=='siang' ? `<button class="btn btn-sm btn-outline-danger" onclick="delUser(${i})">åˆªé™¤</button>` : ''}
        </div>`).join('');
}

async function addUser() {
    // é©—è­‰æœ€é«˜æ¬Šé™å¯†ç¢¼
    const pwdCheck = prompt("è«‹è¼¸å…¥æœ€é«˜æ¬Šé™(siang)çš„å¯†ç¢¼ä»¥ç¢ºèªæ–°å¢:");
    if(pwdCheck !== '1234') return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–");

    const n = document.getElementById('new-u-name').value;
    const p = document.getElementById('new-u-pwd').value;
    const s = document.getElementById('new-u-safe').value;
    const r = document.getElementById('new-u-role').value;
    
    if(!n || !p) return alert("è³‡æ–™ä¸å®Œæ•´");
    if(users.some(x => x.user === n)) return alert("å¸³è™Ÿå·²å­˜åœ¨");

    users.push({user:n, pwd:p, role:r, safe:s});
    await saveUserDB();
    // æ¸…ç©ºè¼¸å…¥
    document.getElementById('new-u-name').value='';
    document.getElementById('new-u-pwd').value='';
    document.getElementById('new-u-safe').value='';
}

async function delUser(idx) {
    const pwdCheck = prompt("è«‹è¼¸å…¥æœ€é«˜æ¬Šé™(siang)çš„å¯†ç¢¼ä»¥ç¢ºèªåˆªé™¤:");
    if(pwdCheck !== '1234') return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–");

    users.splice(idx, 1);
    await saveUserDB();
}

async function saveUserDB() {
    await db.from('daily_data').upsert({date_key: 'USERS', memo_text: JSON.stringify(users)});
    renderUserUI();
    alert("ä½¿ç”¨è€…è³‡æ–™å·²æ›´æ–°");
}

// --- 8. ç³»çµ±è¼‰å…¥èˆ‡ä¸»é¡Œ ---
async function loadConfig() {
    const { data } = await db.from('daily_data').select('*').eq('date_key', 'CONFIG').maybeSingle();
    if(data) {
        sysConfig = JSON.parse(data.memo_text);
    }
    renderConfigUI();
}

async function loadUsers() {
    const { data } = await db.from('daily_data').select('*').eq('date_key', 'USERS').maybeSingle();
    if(data) {
        users = JSON.parse(data.memo_text);
    }
    renderUserUI();
}

function updateTheme() {
    setTheme(sysConfig.theme);
    setAccent(sysConfig.accent);
}

function setTheme(t) {
    sysConfig.theme = t;
    document.body.className = (t==='light' ? 'light-theme' : '');
}
function setAccent(c) {
    sysConfig.accent = c;
    document.documentElement.style.setProperty('--accent-color', c);
}

// è¼”åŠ©
function val(id) { return parseFloat(document.getElementById(id)?.value) || 0; }
function toggle(id, d) {
    const el = document.getElementById(`box-${id}-${d}`);
    const arr = document.getElementById(`arr-${id}-${d}`);
    const isHidden = el.style.display === 'none';
    el.style.display = isHidden ? 'block' : 'none';
    arr.innerText = isHidden ? 'â–²' : 'â–¼';
}
function showPage(p) {
    document.querySelectorAll('.page-content').forEach(pg=>pg.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(ni=>ni.classList.remove('active'));
    document.getElementById('page'+p).classList.add('active');
    document.getElementById('nav-'+p).classList.add('active');
}
function toggleBossMode() { document.getElementById('reportArea').classList.toggle('boss-mode-blur'); }
</script>
</body>
</html>
