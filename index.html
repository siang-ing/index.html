<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026 åº—å‹™ç³»çµ± - è·¨æœˆæ——è‰¦ç‰ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { 
      --bg-color: #121212; --text-color: #ffffff; --accent-color: #bb86fc;
      --card-bg: rgba(255,255,255,0.08); --input-bg: rgba(255,255,255,0.12);
      --hint: #03dac6; --danger: #ff5252;
    }
    body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; padding-bottom: 90px; }
    .light-theme { --bg-color: #f8f9fa; --text-color: #212529; --accent-color: #6200ee; --card-bg: #ffffff; --input-bg: #ffffff; }
    
    #login-overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .mobile-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin: 10px 15px; border-left: 4px solid var(--accent-color); }
    .card-date { font-weight: bold; color: var(--accent-color); display: flex; justify-content: space-between; cursor: pointer; align-items: center; }
    .form-label { font-size: 0.8rem; color: #aaa; margin-bottom: 2px; font-weight: bold; }
    .form-control-mobile { background: var(--input-bg) !important; border: 1px solid #444 !important; color: var(--text-color) !important; border-radius: 6px; padding: 6px; font-size: 0.9rem; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(0,0,0,0.9); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
    .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 0.7rem; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--accent-color); font-weight: bold; }
    .nav-item i { display: block; font-size: 1.2rem; font-style: normal; margin-bottom: 2px; }
    .page-content { display: none; padding-top: 10px; }
    .page-content.active { display: block; }
    .sync-status { position: fixed; top: 10px; right: 10px; padding: 4px 12px; border-radius: 20px; font-size: 11px; z-index: 10001; }
    .boss-mode-blur .report-val { filter: blur(10px); }
    .today-tag { background: var(--hint); color: #000; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: bold; }
    .month-selector { background: var(--card-bg); margin: 0 15px 15px 15px; padding: 12px; border-radius: 12px; border: 1px solid var(--accent-color); display: flex; align-items: center; justify-content: space-between; }
  </style>
</head>
<body>

<div id="sync-indicator" class="sync-status text-white" style="display:none; background: var(--hint);"></div>

<div id="login-overlay">
  <div class="p-4 w-100" style="max-width: 350px;">
    <h3 class="text-center mb-4" style="color: var(--accent-color);">2026 åº—å‹™ç³»çµ±</h3>
    <select id="user-select" class="form-select form-control-mobile mb-3"></select>
    <input type="password" id="login-pwd" class="form-control-mobile form-control mb-4" placeholder="å¯†ç¢¼">
    <button class="btn btn-primary w-100 py-2" onclick="authLogin()" style="background:var(--accent-color); border:none;">ç¢ºèªç™»å…¥</button>
  </div>
</div>

<div id="app" style="display:none;">
  
  <div id="pageA" class="page-content active">
    <div class="month-selector">
        <span style="font-weight:bold;">ğŸ“… å ±è¡¨æœˆä»½</span>
        <input type="month" id="global-month" class="form-control-mobile" style="width: 140px;" onchange="changeMonth()">
    </div>
    <h5 class="text-center mb-3">A. æ¯æ—¥ç‡Ÿæ”¶</h5>
    <div id="listA"></div>
  </div>

  <div id="pageB" class="page-content">
    <h5 class="text-center mb-3">B. é›¶ç”¨é‡‘æ”¯å‡º</h5>
    <div class="mobile-card">
        <label>ä¸Šæœˆé›¶ç”¨é¤˜é¡ (æœ¬æœˆç¨ç«‹):</label> 
        <input type="number" id="prevPetty" class="form-control-mobile d-inline-block w-50 ms-2" onchange="saveSystem()">
    </div>
    <div id="listB"></div>
  </div>

  <div id="pageC" class="page-content">
    <h5 class="text-center mb-3">C. éŠ€è¡Œæ”¶æ”¯</h5>
    <div class="mobile-card">
        <label>ä¸ŠæœˆéŠ€è¡Œé¤˜é¡ (æœ¬æœˆç¨ç«‹):</label> 
        <input type="number" id="prevBank" class="form-control-mobile d-inline-block w-50 ms-2" onchange="saveSystem()">
    </div>
    <div id="listC"></div>
  </div>

  <div id="pageD" class="page-content">
    <h5 class="text-center mb-3">D. å» å•†æœˆçµé€²è²¨</h5>
    <div id="listD"></div>
  </div>

  <div id="pageE" class="page-content">
    <h5 class="text-center mb-3">E. æœˆåº¦æç›Šå ±è¡¨ <button class="btn btn-sm btn-outline-secondary" onclick="toggleBossMode()">ğŸ‘ï¸</button></h5>
    <div class="mobile-card">
        <label>æˆ¿ç§Ÿæ”¯å‡º (æœ¬æœˆç¨ç«‹):</label> 
        <input type="number" id="rentInput" class="form-control-mobile d-inline-block w-50 ms-2" onchange="saveSystem()">
    </div>
    <div id="reportArea"></div>
  </div>

  <div id="pageF" class="page-content">
    <h5 class="text-center text-danger">F. å¾Œå°è¨­å®š</h5>
    <div class="px-3" id="config-ui">
        <div class="mobile-card">
            <h6>1. ä¸»é¡Œè¨­å®š</h6>
            <button class="btn btn-sm btn-dark w-100 mb-2" onclick="setTheme('dark')">æ·±è‰²æ¨¡å¼</button>
            <button class="btn btn-sm btn-light w-100 mb-2" onclick="setTheme('light')">æ·ºè‰²æ¨¡å¼</button>
            <label class="form-label mt-2">æ¨¡çµ„é¡è‰²</label>
            <input type="color" id="accentColorPicker" class="form-control mb-3" onchange="setAccent(this.value)">
        </div>
        <div class="mobile-card">
            <h6>2. Aé æ”¯ä»˜æ–¹å¼ç®¡ç†</h6>
            <div id="config-pay-list"></div>
            <button class="btn btn-sm btn-info w-100" onclick="addPayConfig()">+ æ–°å¢æ”¯ä»˜æ–¹å¼</button>
        </div>
        <button class="btn btn-danger w-100 mt-4 py-2" onclick="saveFullConfig()">å„²å­˜æ‰€æœ‰å¾Œå°è¨­å®š</button>
    </div>
  </div>

  <div id="pageG" class="page-content">
    <h5 class="text-center text-danger">G. ä½¿ç”¨è€…ç®¡ç†</h5>
    <div class="px-3">
        <div id="user-manage-list"></div>
        <div class="mobile-card mt-3">
            <h6>æ–°å¢ä½¿ç”¨è€…</h6>
            <input type="text" id="new-u-name" class="form-control-mobile w-100 mb-2" placeholder="å¸³è™Ÿ">
            <input type="password" id="new-u-pwd" class="form-control-mobile w-100 mb-2" placeholder="å¯†ç¢¼">
            <input type="text" id="new-u-safe" class="form-control-mobile w-100 mb-2" placeholder="å®‰å…¨å•é¡Œ">
            <button class="btn btn-success w-100" onclick="addUser()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showPage('A')"><i>ğŸ“Š</i>ç‡Ÿæ”¶</div>
    <div class="nav-item" onclick="showPage('B')"><i>ğŸ’¸</i>æ”¯å‡º</div>
    <div class="nav-item" onclick="showPage('C')"><i>ğŸ¦</i>éŠ€è¡Œ</div>
    <div class="nav-item" onclick="showPage('D')"><i>ğŸšš</i>é€²è²¨</div>
    <div class="nav-item" onclick="showPage('E')"><i>ğŸ“ˆ</i>å ±è¡¨</div>
    <div class="nav-item admin-btn" style="display:none" onclick="showPage('F')"><i>âš™ï¸</i>å¾Œå°</div>
    <div class="nav-item admin-btn" style="display:none" onclick="showPage('G')"><i>ğŸ‘¤</i>æ¬Šé™</div>
  </nav>
</div>

<script>
// --- 1. æ ¸å¿ƒè¨­å®šèˆ‡è®Šæ•¸ ---
let sysConfig = { theme:'dark', accent:'#bb86fc', pay:[{name:'ä¿¡ç”¨å¡', pct:0.98}, {name:'å…¨æ”¯ä»˜', pct:0.98}, {name:'UBER', pct:0.65}] };
let users = [{user:'siang', pwd:'1234', role:'admin', safe:'è€é—†'}];
const SB_URL = "https://jxtjkjexnqfhxmwfgcgl.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4dGpramV4bnFmaHhtd2ZnY2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTA4ODEsImV4cCI6MjA4NjM2Njg4MX0.Ebw_qhA3Z_p_tB_EwxWmvC0z3oC9MisDQm6DEuGkno0";
const db = supabase.createClient(SB_URL, SB_KEY);

// --- 2. åˆå§‹åŒ–èˆ‡ç™»å…¥ ---
window.onload = async () => {
    // è¨­å®šé è¨­æœˆä»½ç‚ºç•¶å‰æœˆä»½
    const now = new Date();
    document.getElementById('global-month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    await loadUsers(); await loadConfig(); renderUserSelect(); renderUserList(); renderConfig();
};

async function authLogin() {
    const u = document.getElementById('user-select').value, p = document.getElementById('login-pwd').value;
    const found = users.find(x=>x.user===u && x.pwd===p);
    if(found) {
        document.getElementById('login-overlay').style.display='none';
        document.getElementById('app').style.display='block';
        if(found.role==='admin') document.querySelectorAll('.admin-btn').forEach(b=>b.style.display='block');
        initApp();
    } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
}

function initApp() {
    // ä¾æ“šé¸æ“‡çš„æœˆä»½æ¸²æŸ“é é¢
    renderPages();
    loadDailyData(); // è¼‰å…¥è³‡æ–™
    setTheme(sysConfig.theme); setAccent(sysConfig.accent);
}

function changeMonth() {
    // ç•¶æœˆä»½åˆ‡æ›æ™‚ï¼Œé‡æ–°æ¸²æŸ“æ—¥æœŸå¡ç‰‡ä¸¦è¼‰å…¥è©²æœˆè³‡æ–™
    renderPages();
    loadDailyData();
}

// --- 3. é é¢ç”Ÿæˆ (å…¨é é¢æ”¶æ‘º + ä»Šæ—¥è‡ªå‹•å°èˆª) ---
function renderPages() {
    const monthStr = document.getElementById('global-month').value; // 2026-02
    const [year, month] = monthStr.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate(); // è‡ªå‹•è¨ˆç®—è©²æœˆæœ‰å¹¾å¤©
    const todayDate = new Date();
    const isCurrentMonth = (year === todayDate.getFullYear() && month === (todayDate.getMonth()+1));
    const todayDay = todayDate.getDate();

    // é€šç”¨æ¸²æŸ“å™¨ï¼šè² è²¬ç”¢ç”Ÿæ¯ä¸€å¤©çš„å¡ç‰‡
    const buildList = (containerId, title, innerHTMLFunc) => {
        let h = '';
        for(let d=1; d<=daysInMonth; d++) {
            const isToday = (isCurrentMonth && d === todayDay);
            // é è¨­å±•é–‹ä»Šæ—¥ï¼Œå…¶ä»–æ”¶èµ·
            const displayStyle = isToday ? 'block' : 'none';
            const arrowIcon = isToday ? 'â–²' : 'â–¼';
            
            h += `<div class="mobile-card">
                <div class="card-date" onclick="toggleDate('${containerId}', ${d})">
                    <span>${month}/${d} ${title} ${isToday ? '<span class="today-tag">ä»Šæ—¥</span>' : ''}</span>
                    <span id="arr-${containerId}-${d}">${arrowIcon}</span>
                </div>
                <div id="box-${containerId}-${d}" style="display:${displayStyle}; border-top:1px solid rgba(255,255,255,0.1); margin-top:10px; padding-top:10px;">
                    ${innerHTMLFunc(d)}
                </div>
            </div>`;
        }
        document.getElementById('list'+containerId).innerHTML = h;
    };

    // A é å…§å®¹
    buildList('A', 'ç‡Ÿæ”¶', (d) => `
        <div class="row g-2">
            <div class="col-6"><label class="form-label">ç¾é‡‘ (é è¨­6k)</label><input type="number" id="cash-${d}" class="form-control-mobile w-100" value="6000" onchange="sync(${d})"></div>
            <div class="col-6"><label class="form-label">åº•éŒ¢ (é è¨­6k)</label><input type="number" id="reg-${d}" class="form-control-mobile w-100" value="6000" onchange="sync(${d})"></div>
            ${sysConfig.pay.map((p,i)=>`<div class="col-4"><label class="form-label">${p.name}</label><input type="number" id="pay-${i}-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
            <div class="col-6"><label class="form-label text-warning">é…’æ°´ç‡Ÿæ”¶</label><input type="number" id="alc-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
            <div class="col-4"><label class="form-label">å…¥éŠ€è¡Œ</label><input type="number" id="abank-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
            <div class="col-4"><label class="form-label">å…¥é›¶ç”¨</label><input type="number" id="apetty-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
            <div class="col-12 mt-2 text-end">æ­£è² é›¶: <b id="diff-${d}">0</b></div>
        </div>
    `);

    // B é å…§å®¹ (10é …å›ºå®š)
    const bCats = ["é£Ÿå“æ”¯å‡º", "é…’é¡æ”¯å‡º", "å¤–å¸¶é¤ç›’", "å…¶é¤˜é›œæ”¯", "å‹å¥ä¿", "PT", "é›»ä¿¡", "é›»è²»", "æ°´è²»", "ç“¦æ–¯"];
    buildList('B', 'æ”¯å‡º', (d) => `
        <div class="row g-2">
            ${bCats.map((c,i)=>`<div class="col-6"><label class="form-label">${c}</label><input type="number" id="b-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
        </div>
    `);

    // C é å…§å®¹ (8é …å›ºå®š)
    const cCats = ["å…¨æ”¯ä»˜æ”¶å…¥", "ä¿¡ç”¨å¡æ”¶å…¥", "UBERæ”¶å…¥", "å…¶é¤˜æ”¶å…¥", "é£Ÿå“æ”¯å‡º", "é…’é¡æ”¯å‡º", "é›œæ”¯æ¬¾", "äººäº‹æ¬¾"];
    buildList('C', 'éŠ€è¡Œ', (d) => `
        <div class="row g-2">
            ${cCats.map((c,i)=>`<div class="col-6"><label class="form-label">${c}</label><input type="number" id="c-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
        </div>
    `);

    // D é å…§å®¹ (5å» å•†)
    const dCats = ["èœå•†", "æµ·é®®å•†", "è‚‰å•†", "é…’å•†", "é›œè²¨å•†"];
    buildList('D', 'é€²è²¨', (d) => `
        <div class="row g-2">
            ${dCats.map((c,i)=>`<div class="col-6"><label class="form-label">${c}</label><input type="number" id="d-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
        </div>
    `);
}

// --- 4. è³‡æ–™å­˜å– (è·¨æœˆæ ¸å¿ƒé‚è¼¯) ---
async function sync(d) {
    const monthKey = document.getElementById('global-month').value; // e.g., "2026-02"
    const fullDate = `${monthKey}-${d.toString().padStart(2,'0')}`; // e.g., "2026-02-12"
    
    const ind = document.getElementById('sync-indicator');
    ind.style.display='block'; ind.innerText="â³ åŒæ­¥ä¸­...";
    
    const data = {
        date_key: fullDate,
        cash: val(`cash-${d}`), reg_val: val(`reg-${d}`), alc_val: val(`alc-${d}`),
        bank_in: val(`abank-${d}`), petty_in: val(`apetty-${d}`),
        pay_vals: sysConfig.pay.map((_,i)=> val(`pay-${i}-${d}`)),
        b_vals: [0,1,2,3,4,5,6,7,8,9].map(i=> val(`b-v-${d}-${i}`)),
        c_vals: [0,1,2,3,4,5,6,7].map(i=> val(`c-v-${d}-${i}`)),
        d_vals: [0,1,2,3,4].map(i=> val(`d-v-${d}-${i}`))
    };

    const { error } = await db.from('daily_data').upsert(data);
    if(!error) { 
        ind.innerText="âœ“ å·²å„²å­˜"; 
        setTimeout(()=>ind.style.display='none',1500); 
        calcAll(); 
    }
}

async function loadDailyData() {
    // 1. å…ˆæ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¡†ï¼Œé¿å…é¡¯ç¤ºä¸Šå€‹æœˆçš„æ®˜ç•™è³‡æ–™
    document.querySelectorAll('input[type="number"]').forEach(el => {
        if(!el.id.includes('prev') && el.id!=='rentInput') el.value = '';
    });

    const monthKey = document.getElementById('global-month').value; // "2026-02"

    // 2. è¼‰å…¥è©²æœˆä»½çš„ System è¨­å®š (ç¨ç«‹å­˜æª”)
    const sysReq = await db.from('daily_data').select('*').eq('date_key', `SYS-${monthKey}`).maybeSingle();
    if(sysReq.data) {
        document.getElementById('prevPetty').value = sysReq.data.cash;
        document.getElementById('prevBank').value = sysReq.data.bank_in;
        document.getElementById('rentInput').value = sysReq.data.reg_val;
    } else {
        // å¦‚æœè©²æœˆæ²’æœ‰è¨­å®šéï¼Œæ­¸é›¶
        document.getElementById('prevPetty').value = 0;
        document.getElementById('prevBank').value = 0;
        document.getElementById('rentInput').value = 0;
    }

    // 3. è¼‰å…¥è©²æœˆä»½çš„æ‰€æœ‰æ—¥è³‡æ–™
    const { data } = await db.from('daily_data').select('*').like('date_key', `${monthKey}%`);
    if(data) {
        data.forEach(item => {
            const d = parseInt(item.date_key.split('-')[2]); // å–å¾—æ—¥æœŸ
            if(!document.getElementById(`cash-${d}`)) return; // å¦‚æœè©²æ—¥æœŸä¸å­˜åœ¨(ä¾‹å¦‚2æœˆ30æ—¥)å‰‡è·³é

            document.getElementById(`cash-${d}`).value = item.cash || 6000;
            document.getElementById(`reg-${d}`).value = item.reg_val || 6000;
            document.getElementById(`alc-${d}`).value = item.alc_val || 0;
            document.getElementById(`abank-${d}`).value = item.bank_in || 0;
            document.getElementById(`apetty-${d}`).value = item.petty_in || 0;
            
            item.pay_vals?.forEach((v,i)=> { if(document.getElementById(`pay-${i}-${d}`)) document.getElementById(`pay-${i}-${d}`).value=v; });
            item.b_vals?.forEach((v,i)=> { if(document.getElementById(`b-v-${d}-${i}`)) document.getElementById(`b-v-${d}-${i}`).value=v; });
            item.c_vals?.forEach((v,i)=> { if(document.getElementById(`c-v-${d}-${i}`)) document.getElementById(`c-v-${d}-${i}`).value=v; });
            item.d_vals?.forEach((v,i)=> { if(document.getElementById(`d-v-${d}-${i}`)) document.getElementById(`d-v-${d}-${i}`).value=v; });
        });
    }
    calcAll();
}

async function saveSystem() {
    const monthKey = document.getElementById('global-month').value;
    // å„²å­˜ç‚º SYS-2026-02 é€™æ¨£çš„æ ¼å¼ï¼Œç¢ºä¿æ¯å€‹æœˆç¨ç«‹
    await db.from('daily_data').upsert({ 
        date_key: `SYS-${monthKey}`, 
        cash: val('prevPetty'), 
        bank_in: val('prevBank'), 
        reg_val: val('rentInput') 
    });
    calcAll();
}

// --- 5. å ±è¡¨è¨ˆç®— (å®Œæ•´é‚è¼¯) ---
function calcAll() {
    const monthStr = document.getElementById('global-month').value;
    const [y, m] = monthStr.split('-').map(Number);
    const daysInMonth = new Date(y, m, 0).getDate();

    let tRev=0, tAlcRev=0, tFoodRev=0;
    let tB_Food=0, tB_Alc=0, tB_Misc=0, tB_HR=0;
    let tC_Food=0, tC_Alc=0, tC_Misc=0, tC_HR=0;
    let tD_Food=0, tD_Alc=0, tD_Misc=0;

    for(let d=1; d<=daysInMonth; d++) {
        // A é 
        let dPay = 0; sysConfig.pay.forEach((p,i)=> dPay += (val(`pay-${i}-${d}`) * p.pct));
        tRev += (val(`cash-${d}`) + dPay - val(`reg-${d}`));
        tAlcRev += val(`alc-${d}`);
        
        // A é æ­£è² é›¶
        let diff = Math.round((val(`cash-${d}`) - val(`reg-${d}`)) - (val(`abank-${d}`) + val(`apetty-${d}`)));
        const de = document.getElementById(`diff-${d}`);
        if(de) { de.innerText = diff; de.style.color = (diff===0)?'var(--hint)':'var(--danger)'; }

        // B é ç´¯åŠ 
        tB_Food += val(`b-v-${d}-0`); 
        tB_Alc += val(`b-v-${d}-1`);
        tB_HR += (val(`b-v-${d}-4`) + val(`b-v-${d}-5`)); // å‹å¥ä¿+PT
        // é›œæ”¯ = å¤–å¸¶(2) + å…¶é¤˜(3) + é›»ä¿¡(6) + é›»(7) + æ°´(8) + ç“¦æ–¯(9)
        [2,3,6,7,8,9].forEach(i => tB_Misc += val(`b-v-${d}-${i}`));

        // C é ç´¯åŠ  (å¾ index 4 é–‹å§‹æ˜¯æ”¯å‡º)
        tC_Food += val(`c-v-${d}-4`);
        tC_Alc += val(`c-v-${d}-5`);
        tC_Misc += val(`c-v-${d}-6`);
        tC_HR += val(`c-v-${d}-7`);

        // D é ç´¯åŠ 
        tD_Food += (val(`d-v-${d}-0`) + val(`d-v-${d}-1`) + val(`d-v-${d}-2`)); // èœ+æµ·+è‚‰
        tD_Alc += val(`d-v-${d}-3`);
        tD_Misc += val(`d-v-${d}-4`);
    }

    tFoodRev = tRev - tAlcRev;
    const costF = tB_Food + tC_Food + tD_Food;
    const costA = tB_Alc + tC_Alc + tD_Alc;
    const costM = tB_Misc + tC_Misc + tD_Misc;
    const costHR = tB_HR + tC_HR;
    const rent = val('rentInput');
    
    const totalCostFood = costF + costA; // ç¸½é£Ÿææˆæœ¬
    const totalExp = totalCostFood + costM + costHR + rent;
    const profit = tRev - totalExp;

    const pct = (a, b) => b === 0 ? 0 : ((a/b)*100).toFixed(1);

    document.getElementById('reportArea').innerHTML = `
        <div class="row g-2 boss-mode-blur mt-2">
            <div class="col-12"><div class="mobile-card text-center" style="border-left:none; background:var(--accent-color); color:#000;">
                <h6>æœ¬æœˆç²åˆ©</h6><h2 class="report-val" style="font-weight:900">${Math.round(profit).toLocaleString()}</h2>
            </div></div>
            <div class="col-6"><div class="mobile-card">ç¸½ç‡Ÿæ¥­é¡<br><b class="report-val">${Math.round(tRev).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">ç¸½æ”¯å‡º<br><b class="report-val text-danger">${Math.round(totalExp).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é£Ÿææˆæœ¬ (${pct(costF, tFoodRev)}%)<br><b class="report-val">${Math.round(costF).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é…’æ°´æˆæœ¬ (${pct(costA, tAlcRev)}%)<br><b class="report-val">${Math.round(costA).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">ç¸½é£Ÿææˆæœ¬ (${pct(totalCostFood, tRev)}%)<br><b class="report-val">${Math.round(totalCostFood).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">äººäº‹æˆæœ¬<br><b class="report-val">${Math.round(costHR).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é›œæ”¯ç¸½é¡<br><b class="report-val">${Math.round(costM).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">æˆ¿ç§Ÿ<br><b class="report-val">${rent.toLocaleString()}</b></div></div>
        </div>`;
}

// --- 6. è¼”åŠ©åŠŸèƒ½ ---
function toggleDate(type, d) {
    const el = document.getElementById(`box-${type}-${d}`);
    const arr = document.getElementById(`arr-${type}-${d}`);
    const isHidden = el.style.display === 'none';
    el.style.display = isHidden ? 'block' : 'none';
    arr.innerText = isHidden ? 'â–²' : 'â–¼';
}
function showPage(p) {
    document.querySelectorAll('.page-content').forEach(pg=>pg.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(ni=>ni.classList.remove('active'));
    document.getElementById('page'+p).classList.add('active');
    event.currentTarget.classList.add('active');
}
function toggleBossMode() { document.getElementById('reportArea').classList.toggle('boss-mode-blur'); }
function val(id) { return parseFloat(document.getElementById(id)?.value) || 0; }

// F é  & G é ç›¸é—œ
async function loadConfig() { const { data } = await db.from('daily_data').select('*').eq('date_key', 'CONFIG').maybeSingle(); if(data) { sysConfig = JSON.parse(data.memo_text); renderConfig(); } }
async function loadUsers() { const { data } = await db.from('daily_data').select('*').eq('date_key', 'USERS').maybeSingle(); if(data) { users = JSON.parse(data.memo_text); renderUserSelect(); renderUserList(); } }
async function saveFullConfig() { await db.from('daily_data').upsert({ date_key: 'CONFIG', memo_text: JSON.stringify(sysConfig) }); alert("è¨­å®šå·²å„²å­˜"); }
function renderConfig() { 
    document.getElementById('config-pay-list').innerHTML = sysConfig.pay.map((p,i)=>`
    <div class="d-flex gap-2 mb-2"><input class="form-control-mobile" value="${p.name}" onchange="sysConfig.pay[${i}].name=this.value">
    <input type="number" class="form-control-mobile w-25" value="${p.pct}" step="0.01" onchange="sysConfig.pay[${i}].pct=parseFloat(this.value)">
    <button class="btn btn-sm btn-danger" onclick="sysConfig.pay.splice(${i},1);renderConfig()">âœ•</button></div>`).join('');
}
function addPayConfig() { sysConfig.pay.push({name:'æ–°æ”¯ä»˜', pct:1}); renderConfig(); }
function setTheme(t) { sysConfig.theme = t; document.body.className = (t==='light'?'light-theme':''); }
function setAccent(c) { sysConfig.accent = c; document.documentElement.style.setProperty('--accent-color', c); }
function renderUserList() { document.getElementById('user-manage-list').innerHTML = users.map((u,i)=>`<div class="mobile-card d-flex justify-content-between"><div><b>${u.user}</b></div><button class="btn btn-sm btn-outline-danger" onclick="delUser(${i})">åˆªé™¤</button></div>`).join(''); }
function renderUserSelect() { document.getElementById('user-select').innerHTML = users.map(u=>`<option value="${u.user}">${u.user}</option>`).join(''); }
async function addUser() { 
    const n=document.getElementById('new-u-name').value, p=document.getElementById('new-u-pwd').value, s=document.getElementById('new-u-safe').value;
    if(!n||!p) return; users.push({user:n, pwd:p, safe:s, role:'staff'}); await db.from('daily_data').upsert({date_key:'USERS', memo_text:JSON.stringify(users)}); renderUserList();
}
async function delUser(i) { if(users[i].user==='siang') return alert('ä¸å¯åˆªé™¤æœ€é«˜æ¬Šé™'); users.splice(i,1); await db.from('daily_data').upsert({date_key:'USERS', memo_text:JSON.stringify(users)}); renderUserList(); }
</script>
</body>
</html>
