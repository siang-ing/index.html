<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026 åº—å‹™é›²ç«¯ç³»çµ± æ——è‰¦ç‰ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* é€™è£¡åŒ…å«äº†æ‰€æœ‰çš„è¦–è¦ºè¨­å®š (CSS) */
    :root { --accent: #bb86fc; --bg: #121212; --card: rgba(255,255,255,0.05); --text: #ffffff; --hint: #03dac6; --danger: #ff5252; --input-bg: rgba(255,255,255,0.1); }
    body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding-bottom: 100px; transition: background 0.3s, color 0.3s; }
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .mobile-card { background: var(--card); border-radius: 15px; padding: 18px; margin: 10px 15px 20px 15px; border-left: 5px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.3); backdrop-filter: blur(10px); }
    .card-date { font-size: 1.1rem; font-weight: bold; color: var(--accent); margin-bottom: 0px; padding: 5px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .form-label { font-size: 0.85rem; color: var(--text); opacity: 1; margin-bottom: 4px; font-weight: bold; }
    .form-control-mobile { height: 48px !important; background-color: var(--input-bg) !important; border: 1px solid rgba(255,255,255,0.2) !important; color: var(--text) !important; font-size: 1rem !important; border-radius: 8px; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
    .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 0.65rem; flex: 1; cursor: pointer; transition: 0.2s; }
    .nav-item.active { color: var(--accent); transform: scale(1.1); }
    .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 2px; font-style: normal; }
    .page-content { display: none; padding: 10px 0; }
    .page-content.active { display: block; }
    .balance-header { background: var(--card); padding: 15px; margin: 10px 15px; border-radius: 10px; border-left: 5px solid var(--hint); font-weight: bold; color: var(--text) !important; }
    .page-total-bar { background: rgba(187, 134, 252, 0.15); padding: 12px; margin: 0 15px 10px 15px; border-radius: 10px; border: 1px solid var(--accent); text-align: center; font-weight: bold; color: var(--text); }
    .dynamic-item-row { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1); }
    .total-summary { background: var(--card); border-radius: 10px; padding: 15px; margin: 10px 15px 20px 15px; border: 1px solid var(--accent); color: var(--text); }
    .report-card { background: var(--card); padding: 12px; border-radius: 12px; text-align: center; border-bottom: 3px solid var(--accent); height: 100%; color: var(--text); transition: 0.3s; }
    .boss-mode-blur .report-val { filter: blur(10px); user-select: none; }
    .sync-status { position: fixed; top: 10px; right: 10px; padding: 4px 12px; border-radius: 20px; font-size: 12px; z-index: 10001; display: none; }
  </style>
</head>
<body data-theme="dark">

<div id="sync-indicator" class="sync-status"></div>

<div id="login-overlay">
  <div class="container p-4" style="max-width: 400px;">
    <h3 class="text-center mb-4" style="color: var(--accent); letter-spacing: 3px;">2026 åº—å‹™ç³»çµ±</h3>
    <div class="mb-3">
      <label class="form-label text-white">ä½¿ç”¨è€…</label>
      <select id="user-select" class="form-select form-control-mobile"></select>
    </div>
    <div class="mb-4">
      <label class="form-label text-white">å¯†ç¢¼</label>
      <input type="password" id="login-pwd" class="form-control form-control-mobile" inputmode="numeric">
    </div>
    <button class="btn btn-primary w-100 py-3" onclick="authLogin()" style="font-weight: bold; background: var(--accent); border:none;">é€²å…¥ç³»çµ±</button>
  </div>
</div>

<div id="app" style="display: none;">
  <div id="pageA" class="page-content active">
    <h4 class="text-center mb-3">A. ç‡Ÿæ”¶æ˜ç´°è¡¨</h4>
    <div class="total-summary row g-0 text-center">
      <div class="col-4 border-end">ç¸½ç‡Ÿæ¥­é¡<br><b id="total-rev" class="text-info">0</b></div>
      <div class="col-4 border-end">é…’æ°´ç‡Ÿæ”¶<br><b id="total-alc-rev" class="text-warning">0</b></div>
      <div class="col-4">ç¸½å¤–å¸¶<br><b id="total-takeout" class="text-success">0</b></div>
    </div>
    <div id="listA"></div>
  </div>

  <div id="pageB" class="page-content">
    <div class="balance-header">ä¸Šæœˆé›¶ç”¨é¤˜é¡: <input type="number" id="prevPetty" class="form-control-mobile d-inline-block ms-2" style="width:120px; height:35px !important" value="0" onchange="calcAll(); syncData('SYSTEM', 0)"></div>
    <div class="page-total-bar">B é ç•¶æœˆç¸½æ”¯å‡º: <span id="page-total-b" class="text-danger">0</span></div>
    <div id="listB"></div>
    <div class="total-summary"><h6 class="mb-2">B. é›¶ç”¨é‡‘æœˆæ”¯å‡ºçµ±è¨ˆ</h6><div id="summaryB" class="row g-2" style="font-size:0.85rem;"></div></div>
  </div>

  <div id="pageC" class="page-content">
    <div class="balance-header">ä¸ŠæœˆéŠ€è¡Œé¤˜é¡: <input type="number" id="prevBank" class="form-control-mobile d-inline-block ms-2" style="width:120px; height:35px !important" value="0" onchange="calcAll(); syncData('SYSTEM', 0)"></div>
    <div class="page-total-bar">C é ç•¶æœˆç¸½æ”¯å‡º: <span id="page-total-c" class="text-danger">0</span></div>
    <div id="listC"></div>
    <div class="total-summary"><h6 class="mb-2">C. éŠ€è¡Œæœˆæ”¶æ”¯çµ±è¨ˆ</h6><div id="summaryC" class="row g-2" style="font-size:0.85rem;"></div></div>
  </div>

  <div id="pageD" class="page-content">
    <h4 class="text-center mb-3">D. æœˆçµå» å•†é€²è²¨</h4>
    <div class="page-total-bar">D é ç•¶æœˆé€²è²¨ç¸½é¡: <span id="page-total-d" class="text-danger">0</span></div>
    <div id="listD"></div>
    <div class="total-summary"><h6 class="mb-2">D. é€²è²¨ç¸½é¡çµ±è¨ˆ</h6><div id="summaryD" class="row g-2" style="font-size:0.85rem;"></div></div>
  </div>

  <div id="pageE" class="page-content">
    <h4 class="text-center mb-3">E. ç•¶æœˆæç›Šå ±è¡¨ <button class="btn btn-sm btn-outline-secondary" onclick="toggleBossMode()">ğŸ‘ï¸</button></h4>
    <div class="balance-header">æˆ¿ç§Ÿæ”¯å‡ºè¨­å®š: <input type="number" id="rentInput" class="form-control-mobile d-inline-block ms-2" style="width:120px; height:35px !important" value="0" onchange="calcAll(); syncData('SYSTEM', 0)"></div>
    <div id="reportArea" class="row g-3 px-3"></div>
  </div>

  <div id="pageF" class="page-content">
    <h4 class="text-center mb-3 text-danger">F. ç³»çµ±ç®¡ç†ä¸­å¿ƒ</h4>
    <div class="px-3">
        <div class="mobile-card">
            <h6>è¨­å®šæç¤º</h6>
            <p style="font-size:0.8rem; opacity:0.8;">è«‹åœ¨æ­¤èª¿æ•´æ”¯ä»˜æ¯”ä¾‹æˆ–æ–°å¢é¡åˆ¥ï¼Œå®Œæˆå¾Œé»æ“Šæœ€ä¸‹æ–¹å„²å­˜ã€‚</p>
        </div>
        <div id="config-area">
          <div class="mobile-card"><h6>1. æ”¯ä»˜æ–¹å¼è¨­å®š</h6><div id="config-pay"></div><button class="btn btn-sm btn-outline-info w-100 mt-2" onclick="addConfigItem('pay')">+ æ–°å¢</button></div>
          <div class="mobile-card"><h6>2. é›¶ç”¨é‡‘é¡åˆ¥</h6><div id="config-catsB"></div><button class="btn btn-sm btn-outline-info w-100 mt-2" onclick="addConfigItem('catsB')">+ æ–°å¢</button></div>
          <div class="mobile-card"><h6>3. éŠ€è¡Œæ”¶æ”¯é¡åˆ¥</h6><div id="config-catsC"></div><button class="btn btn-sm btn-outline-info w-100 mt-2" onclick="addConfigItem('catsC')">+ æ–°å¢</button></div>
          <div class="mobile-card"><h6>4. é€²è²¨å» å•†</h6><div id="config-catsD"></div><button class="btn btn-sm btn-outline-info w-100 mt-2" onclick="addConfigItem('catsD')">+ æ–°å¢</button></div>
        </div>
        <button class="btn btn-warning w-100 mb-5" onclick="saveConfig()">å„²å­˜è¨­å®šä¸¦æ›´æ–°</button>
    </div>
  </div>

  <div id="pageG" class="page-content">
    <h4 class="text-center mb-3 text-danger">G. æ¬Šé™ç®¡ç†</h4>
    <div class="px-3" id="user-list-area"></div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showPage('A')"><i>ğŸ“Š</i>ç‡Ÿæ”¶</div>
    <div class="nav-item" onclick="showPage('B')"><i>ğŸ’¸</i>é›¶ç”¨</div>
    <div class="nav-item" onclick="showPage('C')"><i>ğŸ¦</i>éŠ€è¡Œ</div>
    <div class="nav-item" onclick="showPage('D')"><i>ğŸšš</i>é€²è²¨</div>
    <div class="nav-item" onclick="showPage('E')"><i>ğŸ“ˆ</i>å ±è¡¨</div>
    <div class="nav-item text-danger admin-btn" style="display:none" onclick="showPage('F')"><i>âš™ï¸</i>å¾Œå°</div>
    <div class="nav-item text-danger admin-btn" style="display:none" onclick="showPage('G')"><i>ğŸ‘¤</i>æ¬Šé™</div>
  </nav>
</div>

<script>
// --- æ ¸å¿ƒè³‡æ–™è¨­å®š ---
let sysConfig = {
  theme: { bg: "#121212", accent: "#bb86fc" },
  pay: [{name: "ä¿¡ç”¨å¡", pct: 0.98}, {name: "å…¨æ”¯ä»˜", pct: 0.98}, {name: "UBER", pct: 0.65}],
  catsB: [{name: "é£Ÿå“æ”¯å‡º", group: "é£Ÿæ"}, {name: "å¤–å¸¶é¤ç›’", group: "é›œæ”¯"}, {name: "é…’é¡æ”¯å‡º", group: "é…’æ°´"}],
  catsC: [{name: "å…¨æ”¯ä»˜æ”¶å…¥", group: "æ”¶å…¥"}, {name: "ä¿¡ç”¨å¡æ”¶å…¥", group: "æ”¶å…¥"}, {name: "UBERæ”¶å…¥", group: "æ”¶å…¥"}, {name: "å…¶é¤˜æ”¶å…¥", group: "æ”¶å…¥"}, {name: "é£Ÿå“æ”¯å‡º", group: "é£Ÿæ"}, {name: "é…’é¡æ”¯å‡º", group: "é…’æ°´"}],
  catsD: [{name: "èœå•†", group: "é£Ÿæ"}, {name: "é…’å•†", group: "é…’æ°´"}]
};
let users = [{user: "siang", pwd: "1234", role: "admin"}];
const SB_URL = "https://jxtjkjexnqfhxmwfgcgl.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4dGpramV4bnFmaHhtd2ZnY2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTA4ODEsImV4cCI6MjA4NjM2Njg4MX0.Ebw_qhA3Z_p_tB_EwxWmvC0z3oC9MisDQm6DEuGkno0";
const db = supabase.createClient(SB_URL, SB_KEY);

// --- åˆå§‹åŒ–å•Ÿå‹• ---
window.onload = async function() {
  await loadUsers(); await loadConfig(); renderUserSelect();
};

function renderUserSelect() {
  const sel = document.getElementById('user-select');
  sel.innerHTML = users.map(u => `<option value="${u.user}">${u.user}</option>`).join('');
}

async function authLogin() {
  const u = document.getElementById('user-select').value;
  const p = document.getElementById('login-pwd').value;
  const found = users.find(x => x.user === u && x.pwd === p);
  if(found) {
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    if(found.role === 'admin') document.querySelectorAll('.admin-btn').forEach(b => b.style.display = 'block');
    initSystem();
  } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
}

function initSystem() {
  renderA(); renderDayList('B', sysConfig.catsB); renderDayList('C', sysConfig.catsC); renderDayList('D', sysConfig.catsD);
  loadDailyData(); renderConfig();
}

// --- åŠŸèƒ½å„ªåŒ–ï¼šè‡ªå‹•æ”¶æ‘º A é  ---
function renderA() {
  let html = '';
  const today = new Date().getDate();
  for(let d=1; d<=31; d++) {
    const isToday = (d === today);
    html += `
    <div class="mobile-card">
      <div class="card-date" onclick="toggleDate(${d})">
        <span>2026/1/${d} ${isToday ? '<small class="badge bg-primary ms-2">ä»Šæ—¥</small>' : ''}</span>
        <span id="arrow-${d}">${isToday ? 'â–²' : 'â–¼'}</span>
      </div>
      <div id="content-${d}" style="display: ${isToday ? 'block' : 'none'}; border-top: 1px solid rgba(255,255,255,0.1); margin-top:10px; padding-top:10px;">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">ç¾é‡‘</label><input type="number" id="cash-${d}" class="form-control-mobile w-100" value="6000" onchange="calcAndSync(${d})"></div>
          <div class="col-6"><label class="form-label">æ”¶éŠ€åº•éŒ¢</label><input type="number" id="reg-${d}" class="form-control-mobile w-100" value="6000" onchange="calcAndSync(${d})"></div>
          ${sysConfig.pay.map((p, i) => `<div class="col-4"><label class="form-label">${p.name}</label><input type="number" id="pay-${i}-${d}" class="form-control-mobile w-100" onchange="calcAndSync(${d})"></div>`).join('')}
          <div class="col-6"><label class="form-label text-warning">é…’æ°´æ”¶å…¥</label><input type="number" id="alc-${d}" class="form-control-mobile w-100" onchange="calcAndSync(${d})"></div>
          <div class="col-6"><label class="form-label text-success">å¤–å¸¶æ”¶å…¥</label><input type="number" id="takeout-${d}" class="form-control-mobile w-100" onchange="calcAndSync(${d})"></div>
          <div class="col-4"><label class="form-label">å…¥éŠ€è¡Œ</label><input type="number" id="a-bank-${d}" class="form-control-mobile w-100" onchange="calcAndSync(${d})"></div>
          <div class="col-4"><label class="form-label">å…¥é›¶ç”¨</label><input type="number" id="a-petty-${d}" class="form-control-mobile w-100" onchange="calcAndSync(${d})"></div>
          <div class="col-4"><label class="form-label">æé ˜å…¥æ«ƒ</label><input type="number" id="a-draw-${d}" class="form-control-mobile w-100" onchange="calcAndSync(${d})"></div>
          <div class="col-12 mt-2 pt-2 border-top d-flex justify-content-between">
            <span style="color:var(--hint)">ç‡Ÿæ¥­é¡: <b id="rev-${d}">0</b></span>
            <span>æ­£è² é›¶: <b id="diff-${d}">0</b></span>
          </div>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('listA').innerHTML = html;
}

function toggleDate(d) {
  const c = document.getElementById(`content-${d}`);
  const a = document.getElementById(`arrow-${d}`);
  const isHidden = c.style.display === 'none';
  c.style.display = isHidden ? 'block' : 'none';
  a.innerText = isHidden ? 'â–²' : 'â–¼';
}

function renderDayList(type, cats) {
  let html = '';
  for(let d=1; d<=31; d++) {
    html += `<div class="mobile-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="card-date mb-0">1/${d} ${type==='B'?'é›¶ç”¨':(type==='C'?'éŠ€è¡Œ':'é€²è²¨')}</div>
        <button class="btn btn-sm btn-outline-info" onclick="addDynRow('${type}',${d})">+ æ–°å¢</button>
      </div>
      <div id="${type.toLowerCase()}-items-${d}"></div>
      ${type==='B' ? `<div class="mt-2 pt-2 border-top"><label class="form-label">æé ˜é›¶ç”¨(æ‰£éŠ€è¡Œæ¬¾):</label><input type="number" id="b-fromBank-${d}" class="form-control-mobile w-100 mb-2" onchange="calcAndSync(${d})"></div>` : ''}
    </div>`;
  }
  document.getElementById('list'+type).innerHTML = html;
}

function addDynRow(type, d, saved = null) {
  const container = document.getElementById(`${type.toLowerCase()}-items-${d}`);
  const cats = type==='B'?sysConfig.catsB : (type==='C'?sysConfig.catsC : sysConfig.catsD);
  const div = document.createElement('div');
  div.className = "dynamic-item-row d-flex gap-1";
  div.innerHTML = `<select class="form-select form-select-sm" style="width:35%" onchange="calcAndSync(${d})">${cats.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')}</select>
    <input type="text" placeholder="å“å" class="form-control form-control-sm" style="width:30%" onchange="calcAndSync(${d})">
    <input type="number" placeholder="é‡‘é¡" class="form-control form-control-sm" style="width:25%" onchange="calcAndSync(${d})">
    <button class="btn btn-sm text-danger" onclick="this.parentElement.remove();calcAndSync(${d})">âœ•</button>`;
  if(saved) { div.querySelector('select').value = saved.cat; div.querySelectorAll('input')[0].value = saved.name; div.querySelectorAll('input')[1].value = saved.val; }
  container.appendChild(div);
}

// --- è¨ˆç®—èˆ‡åŒæ­¥ ---
function calcAndSync(d) { calcAll(); syncData('DAILY', d); }

function calcAll() {
  let pty = v('prevPetty'), bnk = v('prevBank');
  let tA_Rev = 0, tA_Alc = 0, tA_Tko = 0;
  let tB_Exp = 0, tC_Exp = 0, tD_Exp = 0;
  let sB = {é£Ÿæ:0,é›œæ”¯:0,é…’æ°´:0,äººäº‹:0}, sC = {é£Ÿæ:0,é›œæ”¯:0,é…’æ°´:0,äººäº‹:0,æ”¶å…¥:0}, sD = {é£Ÿæ:0,é…’æ°´:0};

  for(let d=1; d<=31; d++) {
    let dPay = 0; sysConfig.pay.forEach((p, i) => dPay += (v(`pay-${i}-${d}`) * p.pct));
    let dRev = v(`cash-${d}`) + dPay - v(`reg-${d}`);
    tA_Rev += dRev; tA_Alc += v(`alc-${d}`); tA_Tko += v(`takeout-${d}`);
    if(document.getElementById(`rev-${d}`)) document.getElementById(`rev-${d}`).innerText = Math.round(dRev).toLocaleString();
    
    // åŠŸèƒ½å„ªåŒ–ï¼šæ­£è² é›¶å‹•æ…‹é¡è‰²
    let diff = Math.round((v(`cash-${d}`) - v(`reg-${d}`)) - (v(`a-bank-${d}`) + v(`a-petty-${d}`) - v(`a-draw-${d}`)));
    const de = document.getElementById(`diff-${d}`);
    if(de) { de.innerText = diff; de.style.color = (diff===0) ? "var(--hint)" : "var(--danger)"; de.style.fontWeight = (diff===0) ? "bold" : "900"; }

    let dB = 0; document.querySelectorAll(`#b-items-${d} .dynamic-item-row`).forEach(r => {
      let val = parseFloat(r.querySelectorAll('input')[1].value)||0; dB += val;
      let g = sysConfig.catsB.find(c=>c.name===r.querySelector('select').value)?.group; if(g) sB[g]+=val;
    });
    tB_Exp += dB; pty = pty - dB - v(`a-draw-${d}`) + v(`a-petty-${d}`) + v(`b-fromBank-${d}`);

    let dC_In = v(`a-bank-${d}`), dC_Out = v(`b-fromBank-${d}`);
    document.querySelectorAll(`#c-items-${d} .dynamic-item-row`).forEach(r => {
      let val = parseFloat(r.querySelectorAll('input')[1].value)||0;
      let g = sysConfig.catsC.find(c=>c.name===r.querySelector('select').value)?.group;
      if(g==='æ”¶å…¥') { dC_In += val; sC.æ”¶å…¥ += val; } else { dC_Out += val; if(g) sC[g]+=val; tC_Exp += val; }
    });
    bnk = bnk + dC_In - dC_Out;

    document.querySelectorAll(`#d-items-${d} .dynamic-item-row`).forEach(r => {
      let val = parseFloat(r.querySelectorAll('input')[1].value)||0;
      let g = sysConfig.catsD.find(c=>c.name===r.querySelector('select').value)?.group; if(g) { sD[g]+=val; tD_Exp += val; }
    });
  }
  document.getElementById('page-total-b').innerText = Math.round(tB_Exp).toLocaleString();
  document.getElementById('page-total-c').innerText = Math.round(tC_Exp).toLocaleString();
  document.getElementById('page-total-d').innerText = Math.round(tD_Exp).toLocaleString();
  renderE(sB, sC, sD, tA_Rev, tA_Alc, tA_Tko);
  document.getElementById('total-rev').innerText = Math.round(tA_Rev).toLocaleString();
  document.getElementById('total-alc-rev').innerText = Math.round(tA_Alc).toLocaleString();
  document.getElementById('total-takeout').innerText = Math.round(tA_Tko).toLocaleString();
  const h = (obj) => Object.entries(obj).map(([k, v]) => `<div class="col-6">${k}: <b>${Math.round(v).toLocaleString()}</b></div>`).join('');
  document.getElementById('summaryB').innerHTML = h(sB);
  document.getElementById('summaryC').innerHTML = h(sC);
  document.getElementById('summaryD').innerHTML = h(sD);
}

function renderE(sB, sC, sD, rev, alc, tko) {
  const rent = v('rentInput');
  const foodRev = rev - alc;
  const costF = sB.é£Ÿæ + sC.é£Ÿæ + sD.é£Ÿæ, costA = sB.é…’æ°´ + sC.é…’æ°´ + sD.é…’æ°´;
  const totalExp = costF + costA + sB.äººäº‹ + sC.äººäº‹ + sB.é›œæ”¯ + sC.é›œæ”¯ + rent;
  document.getElementById('reportArea').innerHTML = `
    <div class="col-12"><div class="report-card">æœ¬æœˆé ä¼°ç²åˆ©<b class="report-val text-info d-block" style="font-size:1.8rem">${Math.round(rev-totalExp).toLocaleString()}</b></div></div>
    <div class="col-6"><div class="report-card">ç¸½ç‡Ÿæ¥­é¡<b class="report-val d-block">${Math.round(rev).toLocaleString()}</b></div></div>
    <div class="col-6"><div class="report-card">ç¸½æ”¯å‡º<b class="report-val d-block text-danger">${Math.round(totalExp).toLocaleString()}</b></div></div>
    <div class="col-6"><div class="report-card">é£Ÿæç‡Ÿæ”¶<b class="report-val d-block">${Math.round(foodRev).toLocaleString()}</b></div></div>
    <div class="col-6"><div class="report-card">é…’æ°´ç‡Ÿæ”¶<b class="report-val d-block text-warning">${Math.round(alc).toLocaleString()}</b></div></div>
    <div class="col-6"><div class="report-card">é£Ÿææˆæœ¬<b class="report-val d-block">${Math.round(costF).toLocaleString()}</b></div></div>
    <div class="col-6"><div class="report-card">é…’æ°´æˆæœ¬<b class="report-val d-block">${Math.round(costA).toLocaleString()}</b></div></div>`;
}

// --- åŠŸèƒ½å„ªåŒ–ï¼šåŒæ­¥æç¤ºèˆ‡è€é—†æ¨¡å¼ ---
function toggleBossMode() { document.getElementById('reportArea').classList.toggle('boss-mode-blur'); }

async function syncData(type, d) {
  const key = type==='SYSTEM' ? 'SYSTEM' : `2026-01-${d.toString().padStart(2,'0')}`;
  const data = { date_key: key };
  const ind = document.getElementById('sync-indicator');
  ind.style.display = 'block'; ind.innerText = "â³ åŒæ­¥ä¸­..."; ind.style.background = "#555";
  if(key==='SYSTEM') { data.cash = v('prevPetty'); data.bank_in = v('prevBank'); data.reg = v('rentInput'); }
  else {
    data.cash = v(`cash-${d}`); data.reg_val = v(`reg-${d}`); data.bank_in = v(`a-bank-${d}`); data.petty_in = v(`a-petty-${d}`);
    data.draw_out = v(`a-draw-${d}`); data.alc_val = v(`alc-${d}`); data.takeout_val = v(`takeout-${d}`); data.from_bank = v(`b-fromBank-${d}`);
    data.pay_vals = sysConfig.pay.map((_, i) => v(`pay-${i}-${d}`));
    const getD = (t) => Array.from(document.querySelectorAll(`#${t}-items-${d} .dynamic-item-row`)).map(r => ({ cat: r.querySelector('select').value, name: r.querySelectorAll('input')[0].value, val: parseFloat(r.querySelectorAll('input')[1].value)||0 }));
    data.dyn_items_b = getD('b'); data.dyn_items_c = getD('c'); data.dyn_items_d = getD('d');
  }
  const { error } = await db.from('daily_data').upsert(data);
  if(!error) { ind.innerText = "âœ“ å·²åŒæ­¥"; ind.style.background = "var(--hint)"; setTimeout(()=>ind.style.display='none', 2000); }
  else { ind.innerText = "âœ— å¤±æ•—"; ind.style.background = "var(--danger)"; }
}

async function loadDailyData() {
  const { data } = await db.from('daily_data').select('*');
  if(!data) return;
  data.forEach(item => {
    if(item.date_key === "SYSTEM") {
      document.getElementById('prevPetty').value = item.cash;
      document.getElementById('prevBank').value = item.bank_in;
      document.getElementById('rentInput').value = item.reg || 0;
    } else if(item.date_key.startsWith("2026")) {
      const d = parseInt(item.date_key.split('-')[2]);
      if(!document.getElementById(`cash-${d}`)) return;
      document.getElementById(`cash-${d}`).value = (item.cash && item.cash > 0) ? item.cash : 6000;
      document.getElementById(`reg-${d}`).value = (item.reg_val && item.reg_val > 0) ? item.reg_val : 6000;
      document.getElementById(`a-bank-${d}`).value = item.bank_in;
      document.getElementById(`a-petty-${d}`).value = item.petty_in;
      document.getElementById(`a-draw-${d}`).value = item.draw_out;
      document.getElementById(`alc-${d}`).value = item.alc_val;
      document.getElementById(`takeout-${d}`).value = item.takeout_val;
      document.getElementById(`b-fromBank-${d}`).value = item.from_bank || 0;
      item.pay_vals?.forEach((val, i) => { if(document.getElementById(`pay-${i}-${d}`)) document.getElementById(`pay-${i}-${d}`).value = val; });
      item.dyn_items_b?.forEach(obj => addDynRow('B', d, obj));
      item.dyn_items_c?.forEach(obj => addDynRow('C', d, obj));
      item.dyn_items_d?.forEach(obj => addDynRow('D', d, obj));
    }
  });
  calcAll();
}

// --- é€šç”¨åŠŸèƒ½ ---
async function loadConfig() { const { data } = await db.from('daily_data').select('*').eq('date_key', 'CONFIG').maybeSingle(); if(data) sysConfig = JSON.parse(data.memo_text); }
async function loadUsers() { const { data } = await db.from('daily_data').select('*').eq('date_key', 'USERS').maybeSingle(); if(data) users = JSON.parse(data.memo_text); }
function showPage(p) {
  document.querySelectorAll('.page-content').forEach(pg => pg.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page'+p).classList.add('active');
  const items = Array.from(document.querySelectorAll('.nav-item'));
  const target = items.find(x => x.innerText.includes(p === 'A'?'ç‡Ÿ':p === 'B'?'é›¶':p === 'C'?'éŠ€':p === 'D'?'é€²':p === 'E'?'å ±':p === 'F'?'å¾Œ':'æ¬Š'));
  if(target) target.classList.add('active');
}
const v = (id) => parseFloat(document.getElementById(id)?.value) || 0;
</script>
</body>
</html>
