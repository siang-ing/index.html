<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026 åº—å‹™ç³»çµ± - çµ‚æ¥µç‰ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* é€™è£¡åŒ…å«äº† F é è¦æ±‚çš„é¡è‰²è®Šæ›é‚è¼¯ */
    :root { 
      --bg-color: #121212; --text-color: #ffffff; --accent-color: #bb86fc;
      --card-bg: rgba(255,255,255,0.08); --input-bg: rgba(255,255,255,0.12);
    }
    body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; padding-bottom: 90px; }
    .light-theme { --bg-color: #f8f9fa; --text-color: #212529; --accent-color: #6200ee; --card-bg: #ffffff; --input-bg: #ffffff; }
    
    #login-overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .mobile-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin: 10px 15px; border-left: 4px solid var(--accent-color); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .form-control-mobile { background: var(--input-bg) !important; border: 1px solid #444 !important; color: var(--text-color) !important; border-radius: 6px; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--bg-color); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
    .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 0.7rem; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--accent-color); font-weight: bold; }
    .nav-item i { display: block; font-size: 1.2rem; font-style: normal; margin-bottom: 2px; }
    .page-content { display: none; padding-top: 10px; }
    .page-content.active { display: block; }
    .sync-status { position: fixed; top: 10px; right: 10px; padding: 4px 12px; border-radius: 20px; font-size: 12px; z-index: 10001; }
    .boss-mode-blur .report-val { filter: blur(10px); }
  </style>
</head>
<body>

<div id="sync-indicator" class="sync-status text-white" style="display:none; background: #03dac6;"></div>

<div id="login-overlay">
  <div class="p-4 w-100" style="max-width: 350px;">
    <h3 class="text-center mb-4" style="color: var(--accent-color);">ç³»çµ±ç™»å…¥</h3>
    <select id="user-select" class="form-select form-control-mobile mb-3"></select>
    <input type="password" id="login-pwd" class="form-control-mobile form-control mb-4" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn btn-primary w-100 py-2" onclick="authLogin()" style="background:var(--accent-color); border:none;">ç¢ºèªç™»å…¥</button>
  </div>
</div>

<div id="app" style="display:none;">
  <div id="pageA" class="page-content active">
    <h5 class="text-center mb-3">A. æ¯æ—¥ç‡Ÿæ”¶</h5>
    <div id="listA"></div>
  </div>

  <div id="pageB" class="page-content">
    <h5 class="text-center mb-3">B. é›¶ç”¨é‡‘æ”¯å‡º</h5>
    <div class="mobile-card">ä¸Šæœˆé›¶ç”¨é¤˜é¡: <input type="number" id="prevPetty" class="form-control-mobile d-inline-block w-50" onchange="saveSystem()"></div>
    <div id="listB"></div>
  </div>

  <div id="pageC" class="page-content">
    <h5 class="text-center mb-3">C. éŠ€è¡Œæ”¶æ”¯</h5>
    <div class="mobile-card">ä¸ŠæœˆéŠ€è¡Œé¤˜é¡: <input type="number" id="prevBank" class="form-control-mobile d-inline-block w-50" onchange="saveSystem()"></div>
    <div id="listC"></div>
  </div>

  <div id="pageD" class="page-content">
    <h5 class="text-center mb-3">D. å» å•†æœˆçµé€²è²¨</h5>
    <div id="listD"></div>
  </div>

  <div id="pageE" class="page-content">
    <h5 class="text-center mb-3">E. æœˆåº¦æç›Šå ±è¡¨ <button class="btn btn-sm btn-outline-secondary" onclick="toggleBossMode()">ğŸ‘ï¸</button></h5>
    <div class="mobile-card">æˆ¿ç§Ÿæ”¯å‡º: <input type="number" id="rentInput" class="form-control-mobile d-inline-block w-50" onchange="saveSystem()"></div>
    <div id="reportArea"></div>
  </div>

  <div id="pageF" class="page-content">
    <h5 class="text-center mb-3 text-danger">F. ç³»çµ±ç®¡ç†å¾Œå°</h5>
    <div class="px-3">
        <div class="mobile-card">
            <h6>1. ä¸»é¡Œè¨­å®š</h6>
            <button class="btn btn-sm btn-dark w-100 mb-2" onclick="setTheme('dark')">æ·±è‰²æ¨¡å¼</button>
            <button class="btn btn-sm btn-light w-100 mb-2" onclick="setTheme('light')">æ·ºè‰²æ¨¡å¼</button>
            <label class="form-label mt-2">æ¨¡çµ„é¡è‰² (Accent)</label>
            <input type="color" id="accentColorPicker" class="form-control mb-3" onchange="setAccent(this.value)">
        </div>
        <div class="mobile-card">
            <h6>2. Aé æ”¯ä»˜æ–¹å¼èˆ‡%æ•¸</h6>
            <div id="config-pay-list"></div>
            <button class="btn btn-sm btn-info w-100" onclick="addPayConfig()">+ æ–°å¢æ”¯ä»˜</button>
        </div>
        <button class="btn btn-danger w-100 mt-4 py-2" onclick="saveFullConfig()">å„²å­˜æ‰€æœ‰å¾Œå°è¨­å®š</button>
    </div>
  </div>

  <div id="pageG" class="page-content">
    <h5 class="text-center mb-3 text-danger">G. ä½¿ç”¨è€…æ¬Šé™ç®¡ç†</h5>
    <div class="px-3">
        <div id="user-manage-list"></div>
        <div class="mobile-card mt-3">
            <h6>æ–°å¢ä½¿ç”¨è€…</h6>
            <input type="text" id="new-u-name" class="form-control-mobile w-100 mb-2" placeholder="å¸³è™Ÿ">
            <input type="password" id="new-u-pwd" class="form-control-mobile w-100 mb-2" placeholder="å¯†ç¢¼">
            <input type="text" id="new-u-safe" class="form-control-mobile w-100 mb-2" placeholder="å®‰å…¨å•é¡Œ">
            <button class="btn btn-success w-100" onclick="addUser()">ç¢ºèªæ–°å¢ (éœ€æœ€é«˜æ¬Šé™)</button>
        </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showPage('A')"><i>ğŸ“Š</i>ç‡Ÿæ”¶</div>
    <div class="nav-item" onclick="showPage('B')"><i>ğŸ’¸</i>æ”¯å‡º</div>
    <div class="nav-item" onclick="showPage('C')"><i>ğŸ¦</i>éŠ€è¡Œ</div>
    <div class="nav-item" onclick="showPage('D')"><i>ğŸšš</i>é€²è²¨</div>
    <div class="nav-item" onclick="showPage('E')"><i>ğŸ“ˆ</i>å ±è¡¨</div>
    <div class="nav-item admin-btn" style="display:none" onclick="showPage('F')"><i>âš™ï¸</i>å¾Œå°</div>
    <div class="nav-item admin-btn" style="display:none" onclick="showPage('G')"><i>ğŸ‘¤</i>æ¬Šé™</div>
  </nav>
</div>

<script>
// --- æ ¸å¿ƒè®Šæ•¸ ---
let sysConfig = {
  theme: 'dark', accent: '#bb86fc',
  pay: [{name:'ä¿¡ç”¨å¡', pct:0.98}, {name:'å…¨æ”¯ä»˜', pct:0.98}, {name:'UBER', pct:0.65}],
  catsD: [{name:'èœå•†', type:'food'}, {name:'é…’å•†', type:'alc'}]
};
let users = [{user:'siang', pwd:'1234', role:'admin', safe:'è€é—†'}];
const SB_URL = "https://jxtjkjexnqfhxmwfgcgl.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4dGpramV4bnFmaHhtd2ZnY2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTA4ODEsImV4cCI6MjA4NjM2Njg4MX0.Ebw_qhA3Z_p_tB_EwxWmvC0z3oC9MisDQm6DEuGkno0";
const db = supabase.createClient(SB_URL, SB_KEY);

// --- åˆå§‹åŒ– ---
window.onload = async () => {
  await loadUsers(); await loadConfig(); renderUserSelect(); renderUserList();
};

function renderUserSelect() {
  document.getElementById('user-select').innerHTML = users.map(u=>`<option value="${u.user}">${u.user}</option>`).join('');
}

async function authLogin() {
  const u = document.getElementById('user-select').value, p = document.getElementById('login-pwd').value;
  const found = users.find(x=>x.user===u && x.pwd===p);
  if(found) {
    document.getElementById('login-overlay').style.display='none';
    document.getElementById('app').style.display='block';
    if(found.user==='siang') document.querySelectorAll('.admin-btn').forEach(b=>b.style.display='block');
    initApp();
  } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
}

function initApp() {
  renderA(); renderB(); renderC(); renderD(); loadDailyData();
  setTheme(sysConfig.theme); setAccent(sysConfig.accent);
}

// --- é é¢ç”Ÿæˆ (å›ºå®šæ¬„ä½) ---
function renderA() {
  let h = '';
  for(let d=1; d<=31; d++) {
    h += `<div class="mobile-card">
      <div class="card-date" onclick="toggle('A',${d})"><span>1/${d} ç‡Ÿæ”¶</span><span>â–¼</span></div>
      <div id="c-A-${d}" style="display:none">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">ç¾é‡‘</label><input type="number" id="cash-${d}" class="form-control-mobile w-100" value="6000" onchange="sync(${d})"></div>
          <div class="col-6"><label class="form-label">åº•éŒ¢</label><input type="number" id="reg-${d}" class="form-control-mobile w-100" value="6000" onchange="sync(${d})"></div>
          ${sysConfig.pay.map((p,i)=>`<div class="col-4"><label class="form-label">${p.name}</label><input type="number" id="pay-${i}-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
          <div class="col-6"><label class="form-label">é…’æ°´ç‡Ÿæ”¶</label><input type="number" id="alc-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
          <div class="col-6"><label class="form-label">å…¥éŠ€è¡Œ</label><input type="number" id="abank-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
          <div class="col-6"><label class="form-label">å…¥é›¶ç”¨</label><input type="number" id="apetty-${d}" class="form-control-mobile w-100" onchange="sync(${d})"></div>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('listA').innerHTML = h;
}

function renderB() {
  const cats = ["é£Ÿå“æ”¯å‡º", "é…’é¡æ”¯å‡º", "å¤–å¸¶é¤ç›’", "å…¶é¤˜é›œæ”¯", "å‹å¥ä¿", "PT", "é›»ä¿¡", "é›»è²»", "æ°´è²»", "ç“¦æ–¯"];
  let h = '';
  for(let d=1; d<=31; d++) {
    h += `<div class="mobile-card">
      <div class="card-date" onclick="toggle('B',${d})"><span>1/${d} é›¶ç”¨æ”¯å‡º</span><span>â–¼</span></div>
      <div id="c-B-${d}" style="display:none">
        <div class="row g-2">
          ${cats.map((c,i)=>`<div class="col-6"><label class="form-label">${c}</label><input type="number" id="b-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }
  document.getElementById('listB').innerHTML = h;
}

function renderC() {
  const cats = ["å…¨æ”¯ä»˜æ”¶å…¥", "ä¿¡ç”¨å¡æ”¶å…¥", "UBERæ”¶å…¥", "å…¶é¤˜æ”¶å…¥", "é£Ÿå“æ”¯å‡º", "é…’é¡æ”¯å‡º", "é›œæ”¯æ¬¾", "äººäº‹æ¬¾"];
  let h = '';
  for(let d=1; d<=31; d++) {
    h += `<div class="mobile-card">
      <div class="card-date" onclick="toggle('C',${d})"><span>1/${d} éŠ€è¡Œæ”¶æ”¯</span><span>â–¼</span></div>
      <div id="c-C-${d}" style="display:none">
        <div class="row g-2">
          ${cats.map((c,i)=>`<div class="col-6"><label class="form-label">${c}</label><input type="number" id="c-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }
  document.getElementById('listC').innerHTML = h;
}

function renderD() {
  const cats = ["èœå•†", "æµ·é®®å•†", "è‚‰å•†", "é…’å•†", "é›œè²¨å•†"];
  let h = '';
  for(let d=1; d<=31; d++) {
    h += `<div class="mobile-card">
      <div class="card-date" onclick="toggle('D',${d})"><span>1/${d} å» å•†æœˆçµ</span><span>â–¼</span></div>
      <div id="c-D-${d}" style="display:none">
        <div class="row g-2">
          ${cats.map((c,i)=>`<div class="col-6"><label class="form-label">${c}</label><input type="number" id="d-v-${d}-${i}" class="form-control-mobile w-100" onchange="sync(${d})"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }
  document.getElementById('listD').innerHTML = h;
}

// --- å ±è¡¨é‚è¼¯ (ç²¾å¯†è¨ˆç®—) ---
function calcAll() {
  let tRev = 0, tAlcRev = 0, tFoodRev = 0;
  let tB_Food = 0, tB_Alc = 0, tB_Misc = 0, tB_HR = 0, tB_Total = 0;
  let tC_Food = 0, tC_Alc = 0, tC_Misc = 0, tC_HR = 0, tC_Total = 0;
  let tD_Food = 0, tD_Alc = 0, tD_Misc = 0, tD_Total = 0;

  for(let d=1; d<=31; d++) {
    // A é è¨ˆç®—
    let dPay = 0; sysConfig.pay.forEach((p,i)=> dPay += (val(`pay-${i}-${d}`) * p.pct));
    tRev += (val(`cash-${d}`) + dPay - val(`reg-${d}`));
    tAlcRev += val(`alc-${d}`);
    
    // B é ç´¯åŠ 
    tB_Food += val(`b-v-${d}-0`); tB_Alc += val(`b-v-${d}-1`);
    [2,3,4,6,7,8,9].forEach(i=> tB_Misc += val(`b-v-${d}-${i}`));
    tB_HR += val(`b-v-${d}-5`);
    
    // C é ç´¯åŠ  (æ”¯å‡ºé …å¾ index 4 é–‹å§‹)
    tC_Food += val(`c-v-${d}-4`); tC_Alc += val(`c-v-${d}-5`);
    tC_Misc += val(`c-v-${d}-6`); tC_HR += val(`c-v-${d}-7`);
    
    // D é ç´¯åŠ 
    tD_Food += (val(`d-v-${d}-0`) + val(`d-v-${d}-1`) + val(`d-v-${d}-2`));
    tD_Alc += val(`d-v-${d}-3`); tD_Misc += val(`d-v-${d}-4`);
  }

  tFoodRev = tRev - tAlcRev;
  const costF = tB_Food + tC_Food + tD_Food;
  const costA = tB_Alc + tC_Alc + tD_Alc;
  const costM = tB_Misc + tC_Misc + tD_Misc;
  const costHR = tB_HR + tC_HR;
  const totalCostFood = costF + costA;
  const totalExp = tB_Total + tC_Total + (tD_Food + tD_Alc + tD_Misc) + val('rentInput') + costM + costHR;
  const profit = tRev - totalExp;

  const pct = (a, b) => b === 0 ? 0 : ((a/b)*100).toFixed(1);

  document.getElementById('reportArea').innerHTML = `
    <div class="row g-3 boss-mode-blur">
      <div class="col-12"><div class="mobile-card text-center"><h6>æœ¬æœˆç²åˆ©</h6><h2 class="report-val text-info">${Math.round(profit).toLocaleString()}</h2></div></div>
      <div class="col-6"><div class="mobile-card">ç¸½ç‡Ÿæ¥­é¡<br><b class="report-val">${Math.round(tRev).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">ç¸½æ”¯å‡º<br><b class="report-val text-danger">${Math.round(totalExp).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">é…’æ°´ç‡Ÿæ”¶<br><b class="report-val">${Math.round(tAlcRev).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">é£Ÿæç‡Ÿæ”¶<br><b class="report-val">${Math.round(tFoodRev).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">é£Ÿææˆæœ¬(${pct(costF, tFoodRev)}%)<br><b class="report-val">${Math.round(costF).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">é…’æ°´æˆæœ¬(${pct(costA, tAlcRev)}%)<br><b class="report-val">${Math.round(costA).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">ç¸½é£Ÿææˆæœ¬(${pct(totalCostFood, tRev)}%)<br><b class="report-val">${Math.round(totalCostFood).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">é›œæ”¯ç¸½é¡<br><b class="report-val">${Math.round(costM).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">äººäº‹æˆæœ¬<br><b class="report-val">${Math.round(costHR).toLocaleString()}</b></div></div>
      <div class="col-6"><div class="mobile-card">æˆ¿ç§Ÿ<br><b class="report-val">${val('rentInput').toLocaleString()}</b></div></div>
    </div>`;
}

// --- F é å¾Œå°è¨­å®š ---
function renderConfig() {
    document.getElementById('config-pay-list').innerHTML = sysConfig.pay.map((p,i)=>`
        <div class="d-flex gap-2 mb-2">
            <input type="text" class="form-control-mobile w-50" value="${p.name}" onchange="sysConfig.pay[${i}].name=this.value">
            <input type="number" class="form-control-mobile w-25" value="${p.pct}" step="0.01" onchange="sysConfig.pay[${i}].pct=parseFloat(this.value)">
            <button class="btn btn-sm btn-danger" onclick="sysConfig.pay.splice(${i},1);renderConfig()">âœ•</button>
        </div>`).join('');
}
function addPayConfig() { sysConfig.pay.push({name:'æ–°æ”¯ä»˜', pct:1}); renderConfig(); }
async function saveFullConfig() {
    const { error } = await db.from('daily_data').upsert({ date_key: 'CONFIG', memo_text: JSON.stringify(sysConfig) });
    if(!error) alert("å¾Œå°è¨­å®šå·²å„²å­˜ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚");
}
function setTheme(t) { sysConfig.theme = t; document.body.className = (t==='light'?'light-theme':''); }
function setAccent(c) { sysConfig.accent = c; document.documentElement.style.setProperty('--accent-color', c); }

// --- G é ä½¿ç”¨è€…ç®¡ç† ---
function renderUserList() {
    document.getElementById('user-manage-list').innerHTML = users.map((u,i)=>`
        <div class="mobile-card d-flex justify-content-between align-items-center">
            <div><b>${u.user}</b> (${u.safe})</div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${i})">åˆªé™¤</button>
        </div>`).join('');
}
async function addUser() {
    const n = document.getElementById('new-u-name').value, p = document.getElementById('new-u-pwd').value, s = document.getElementById('new-u-safe').value;
    if(!n || !p) return;
    users.push({user:n, pwd:p, safe:s, role:'staff'});
    await saveUsers();
}
async function deleteUser(i) {
    if(users[i].user==='siang') return alert("ä¸èƒ½åˆªé™¤æœ€é«˜æ¬Šé™è€…");
    users.splice(i,1); await saveUsers();
}
async function saveUsers() {
    await db.from('daily_data').upsert({ date_key: 'USERS', memo_text: JSON.stringify(users) });
    renderUserList(); renderUserSelect();
}

// --- è³‡æ–™å­˜å–é‚è¼¯ ---
async function sync(d) {
    const ind = document.getElementById('sync-indicator');
    ind.style.display='block'; ind.innerText="â³ åŒæ­¥ä¸­...";
    const data = {
        date_key: `2026-01-${d.toString().padStart(2,'0')}`,
        cash: val(`cash-${d}`), reg_val: val(`reg-${d}`), alc_val: val(`alc-${d}`),
        bank_in: val(`abank-${d}`), petty_in: val(`apetty-${d}`),
        pay_vals: sysConfig.pay.map((_,i)=> val(`pay-${i}-${d}`)),
        b_vals: [0,1,2,3,4,5,6,7,8,9].map(i=> val(`b-v-${d}-${i}`)),
        c_vals: [0,1,2,3,4,5,6,7].map(i=> val(`c-v-${d}-${i}`)),
        d_vals: [0,1,2,3,4].map(i=> val(`d-v-${d}-${i}`)),
        memo_text: document.getElementById(`d-memo-${d}`).value
    };
    const { error } = await db.from('daily_data').upsert(data);
    if(!error) { ind.innerText="âœ“ å·²å„²å­˜"; setTimeout(()=>ind.style.display='none',1500); calcAll(); }
}

async function loadDailyData() {
    const { data } = await db.from('daily_data').select('*');
    if(!data) return;
    data.forEach(item => {
        if(item.date_key === 'SYSTEM') {
            document.getElementById('prevPetty').value = item.cash;
            document.getElementById('prevBank').value = item.bank_in;
            document.getElementById('rentInput').value = item.reg_val || 0;
        } else if(item.date_key.startsWith('2026')) {
            const d = parseInt(item.date_key.split('-')[2]);
            if(!document.getElementById(`cash-${d}`)) return;
            document.getElementById(`cash-${d}`).value = item.cash || 6000;
            document.getElementById(`reg-${d}`).value = item.reg_val || 6000;
            document.getElementById(`alc-${d}`).value = item.alc_val || 0;
            document.getElementById(`abank-${d}`).value = item.bank_in || 0;
            document.getElementById(`apetty-${d}`).value = item.petty_in || 0;
            item.pay_vals?.forEach((v,i)=> { if(document.getElementById(`pay-${i}-${d}`)) document.getElementById(`pay-${i}-${d}`).value=v; });
            item.b_vals?.forEach((v,i)=> { if(document.getElementById(`b-v-${d}-${i}`)) document.getElementById(`b-v-${d}-${i}`).value=v; });
            item.c_vals?.forEach((v,i)=> { if(document.getElementById(`c-v-${d}-${i}`)) document.getElementById(`c-v-${d}-${i}`).value=v; });
            item.d_vals?.forEach((v,i)=> { if(document.getElementById(`d-v-${d}-${i}`)) document.getElementById(`d-v-${d}-${i}`).value=v; });
            document.getElementById(`d-memo-${d}`).value = item.memo_text || '';
        }
    });
    calcAll();
}

async function saveSystem() {
    await db.from('daily_data').upsert({ date_key: 'SYSTEM', cash: val('prevPetty'), bank_in: val('prevBank'), reg_val: val('rentInput') });
    calcAll();
}

async function loadConfig() { 
    const { data } = await db.from('daily_data').select('*').eq('date_key', 'CONFIG').maybeSingle(); 
    if(data) { sysConfig = JSON.parse(data.memo_text); renderConfig(); }
}
async function loadUsers() { 
    const { data } = await db.from('daily_data').select('*').eq('date_key', 'USERS').maybeSingle(); 
    if(data) { users = JSON.parse(data.memo_text); renderUserSelect(); renderUserList(); }
}

function showPage(p) {
    document.querySelectorAll('.page-content').forEach(pg=>pg.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(ni=>ni.classList.remove('active'));
    document.getElementById('page'+p).classList.add('active');
    event.currentTarget.classList.add('active');
}
function toggle(p, d) { 
    const el = document.getElementById(`c-${p}-${d}`); 
    el.style.display = (el.style.display==='none'?'block':'none'); 
}
function val(id) { return parseFloat(document.getElementById(id)?.value) || 0; }
function toggleBossMode() { document.getElementById('reportArea').classList.toggle('boss-mode-blur'); }
</script>
</body>
</html>
