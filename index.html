<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026 åº—å‹™æ——è‰¦ç³»çµ± (æœ€çµ‚æ ¸å°ç‰ˆ)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* å…¨åŸŸè¨­å®šï¼šæ·±è‰²ä¸»é¡Œ */
    :root { 
      --bg-color: #121212; --text-color: #e0e0e0; --accent-color: #bb86fc;
      --card-bg: #1e1e1e; --input-bg: #2c2c2c; --nav-bg: #000000;
      --hint: #03dac6; --danger: #cf6679; --safe: #4caf50;
    }
    body { background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 90px; margin: 0; }
    
    /* [é‡è¦ä¿®æ­£] å¼·åˆ¶æ¨™ç±¤å¯è¦‹æ€§ (Page B/C/E) */
    .form-label { 
      font-size: 0.9rem; color: #ffffff !important; font-weight: bold; 
      margin-bottom: 5px; display: block; visibility: visible !important; opacity: 1 !important;
    }
    
    /* å¡ç‰‡èˆ‡è¼¸å…¥æ¡†æ¨£å¼ */
    .mobile-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin: 10px 15px; border-left: 5px solid var(--accent-color); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .card-header-date { font-weight: bold; color: var(--accent-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 8px; border-bottom: 1px solid #333; margin-bottom: 10px; }
    .form-control-mobile { background: var(--input-bg) !important; border: 1px solid #444 !important; color: #fff !important; border-radius: 6px; padding: 8px; width: 100%; }
    .form-control-mobile:focus { border-color: var(--accent-color) !important; box-shadow: none; }

    /* åº•éƒ¨å°èˆª */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 1000; }
    .nav-item { text-align: center; color: #666; font-size: 0.75rem; flex: 1; cursor: pointer; transition: color 0.2s; }
    .nav-item.active { color: var(--accent-color); font-weight: bold; }
    .nav-item i { display: block; font-size: 1.4rem; font-style: normal; margin-bottom: 2px; }

    /* é é¢åˆ‡æ›èˆ‡ç‰¹æ®ŠåŠŸèƒ½ */
    .page-content { display: none; animation: fadeIn 0.2s ease-in-out; }
    .page-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* è®Šè‰²æé†’æ©Ÿåˆ¶ */
    .diff-positive { color: var(--safe) !important; }
    .diff-negative { color: var(--danger) !important; }
    .boss-blur .secret-val { filter: blur(8px); transition: filter 0.3s; }
    
    /* ç™»å…¥é®ç½© */
    #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    
    /* ç‹€æ…‹æ¨™ç±¤ */
    .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: #333; color: #aaa; margin-left: 5px; }
  </style>
</head>
<body>

<div id="login-overlay">
  <div class="p-4" style="width: 85%; max-width: 350px; background: #1e1e1e; border-radius: 16px; border: 1px solid #333;">
    <h3 class="text-center mb-4" style="color: var(--accent-color);">2026 åº—å‹™ç³»çµ±</h3>
    <div class="mb-3">
        <label class="form-label">é¸æ“‡è§’è‰²</label>
        <select id="login-role" class="form-select form-control-mobile">
            <option value="boss">è€é—† (Boss)</option>
            <option value="manager">åº—é•· (Manager)</option>
            <option value="staff">å“¡å·¥ (Staff)</option>
        </select>
    </div>
    <div class="mb-4">
        <label class="form-label">å¯†ç¢¼</label>
        <input type="password" id="login-pwd" class="form-control-mobile" placeholder="è¼¸å…¥å¯†ç¢¼">
    </div>
    <button class="btn btn-primary w-100 py-2 fw-bold" onclick="attemptLogin()" style="background:var(--accent-color); border:none; color:#000;">ç¢ºèªç™»å…¥</button>
    <div id="login-msg" class="text-danger text-center mt-2 small"></div>
  </div>
</div>

<div id="app-container" style="display:none;">
  
  <div id="pageA" class="page-content active">
    <div class="mobile-card">
        <label class="form-label">ğŸ“… çµç®—æœˆä»½</label>
        <input type="month" id="global-month" class="form-control-mobile" onchange="switchMonth()">
    </div>
    <div id="listA"></div>
  </div>

  <div id="pageB" class="page-content">
    <div class="mobile-card" style="border-left-color: #ffb74d;">
        <label class="form-label">ä¸Šæœˆé›¶ç”¨é¤˜é¡:</label> <input type="number" id="prevPetty" class="form-control-mobile" onchange="saveSystemConfig()">
    </div>
    <div id="listB"></div>
  </div>

  <div id="pageC" class="page-content">
    <div class="mobile-card" style="border-left-color: #03dac6;">
        <label class="form-label">ä¸ŠæœˆéŠ€è¡Œé¤˜é¡:</label> <input type="number" id="prevBank" class="form-control-mobile" onchange="saveSystemConfig()">
    </div>
    <div id="listC"></div>
  </div>

  <div id="pageD" class="page-content">
    <div id="listD"></div>
  </div>

  <div id="pageE" class="page-content">
    <div class="mobile-card text-center">
        <h5 class="mb-3">æœˆåº¦æç›Šè¡¨ <button id="boss-eye-btn" class="btn btn-sm btn-outline-light" onclick="toggleBossMode()">ğŸ‘ï¸</button></h5>
        <div class="row g-3">
            <div class="col-12 text-start">
                <label class="form-label">æˆ¿ç§Ÿæ”¯å‡º:</label> <input type="number" id="rentInput" class="form-control-mobile" onchange="saveSystemConfig()">
            </div>
        </div>
        <hr style="border-color: #555;">
        <div id="report-content" class="boss-blur">
            </div>
    </div>
  </div>

  <div id="pageF" class="page-content">
    <div class="mobile-card">
        <h5>âš™ï¸ ç³»çµ±å¾Œå°</h5>
        <p class="text-muted">é€™è£¡å¯ä»¥è¨­å®šç³»çµ±åƒæ•¸èˆ‡å‚™ä»½ã€‚</p>
        <button class="btn btn-danger w-100" onclick="logout()">ç™»å‡ºç³»çµ±</button>
    </div>
  </div>

  <div id="pageG" class="page-content">
    <div class="mobile-card">
        <h5>ğŸ‘¤ å¸³è™Ÿæ¬Šé™ç®¡ç†</h5>
        <ul class="list-group list-group-flush mt-3" style="background:transparent;">
            <li class="list-group-item bg-transparent text-white">è€é—† (Boss) - å…¨æ¬Šé™</li>
            <li class="list-group-item bg-transparent text-white">åº—é•· (Manager) - ç„¡å¾Œå°</li>
            <li class="list-group-item bg-transparent text-white">å“¡å·¥ (Staff) - åƒ…è¼¸å…¥</li>
        </ul>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="navTo('A')" id="nav-A"><i>ğŸ“Š</i>ç‡Ÿæ”¶</div>
    <div class="nav-item" onclick="navTo('B')" id="nav-B"><i>ğŸ’¸</i>æ”¯å‡º</div>
    <div class="nav-item" onclick="navTo('C')" id="nav-C"><i>ğŸ¦</i>éŠ€è¡Œ</div>
    <div class="nav-item" onclick="navTo('D')" id="nav-D"><i>ğŸšš</i>é€²è²¨</div>
    <div class="nav-item" onclick="navTo('E')" id="nav-E" style="display:none;"><i>ğŸ“ˆ</i>å ±è¡¨</div> <div class="nav-item" onclick="navTo('F')" id="nav-F" style="display:none;"><i>âš™ï¸</i>å¾Œå°</div> <div class="nav-item" onclick="navTo('G')" id="nav-G" style="display:none;"><i>ğŸ‘¤</i>æ¬Šé™</div> </nav>

</div>

<script>
// --- 1. æ ¸å¿ƒé…ç½® (å®Œå…¨ä¾ç…§æŒ‡ä»¤ï¼Œä¸ç°¡åŒ–) ---
const ACCOUNTS = {
    'boss': { pwd: '1234', pages: ['A','B','C','D','E','F','G'], canEye: true },
    'manager': { pwd: '5678', pages: ['A','B','C','D','E'], canEye: true },
    'staff': { pwd: '0000', pages: ['A','B','C','D'], canEye: false }
};

// å›ºå®šé …ç›®é…ç½®
const CONFIG = {
    // Page A: æ”¯ä»˜æ–¹å¼ (å«æ‰‹çºŒè²»ç‡)
    pay: [
        { name: 'ä¿¡ç”¨å¡', fee: 0.98 },
        { name: 'å…¨æ”¯ä»˜', fee: 0.98 },
        { name: 'UBER', fee: 0.65 },
        { name: 'é…’æ°´ç‡Ÿæ”¶', fee: 1.00 } // é¡å¤–ç‡Ÿæ”¶é …
    ],
    // Page B: å›ºå®š 10 é …
    catsB: [
        { name: 'é£Ÿå“æ”¯å‡º', type: 'food' },
        { name: 'é…’é¡æ”¯å‡º', type: 'alc' },
        { name: 'å¤–å¸¶é¤ç›’', type: 'misc' },
        { name: 'é›œæ”¯', type: 'misc' },
        { name: 'å‹å¥ä¿', type: 'hr' },
        { name: 'PTè–ªè³‡', type: 'hr' },
        { name: 'é›»ä¿¡è²»', type: 'util' },
        { name: 'é›»è²»', type: 'util' },
        { name: 'æ°´è²»', type: 'util' },
        { name: 'ç“¦æ–¯è²»', type: 'util' }
    ],
    // Page C: éŠ€è¡Œæ”¶æ”¯
    catsC_In: [
        { name: 'å…¨æ”¯ä»˜æ”¶å…¥', type: 'income' },
        { name: 'ä¿¡ç”¨å¡æ”¶å…¥', type: 'income' },
        { name: 'UBERæ”¶å…¥', type: 'income' },
        { name: 'å…¶é¤˜æ”¶å…¥', type: 'income' }
    ],
    catsC_Out: [
        { name: 'é£Ÿå“æ”¯å‡º', type: 'food' },
        { name: 'é…’é¡æ”¯å‡º', type: 'alc' },
        { name: 'é›œæ”¯æ¬¾', type: 'misc' },
        { name: 'äººäº‹æ¬¾', type: 'hr' }
    ],
    // Page D: å›ºå®š 5 å» å•†
    catsD: [
        { name: 'èœå•†', type: 'food' },
        { name: 'æµ·é®®', type: 'food' },
        { name: 'è‚‰å•†', type: 'food' },
        { name: 'é…’å•†', type: 'alc' },
        { name: 'é›œè²¨å•†', type: 'misc' }
    ]
};

// Supabase è¨­å®š
const SB_URL = "https://jxtjkjexnqfhxmwfgcgl.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4dGpramV4bnFmaHhtd2ZnY2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTA4ODEsImV4cCI6MjA4NjM2Njg4MX0.Ebw_qhA3Z_p_tB_EwxWmvC0z3oC9MisDQm6DEuGkno0";
const db = supabase.createClient(SB_URL, SB_KEY);

// ç‹€æ…‹è®Šæ•¸
let currentUser = null;
let currentRole = null;
let currentMonthData = []; // ç•¶æœˆæ‰€æœ‰è³‡æ–™
let currentSysData = {};   // ç•¶æœˆç³»çµ±è¨­å®š (é¤˜é¡ã€æˆ¿ç§Ÿ)

// --- 2. ç™»å…¥èˆ‡åˆå§‹åŒ– ---
window.onload = () => {
    // è¨­å®šé è¨­æœˆä»½
    const now = new Date();
    document.getElementById('global-month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
};

function attemptLogin() {
    const role = document.getElementById('login-role').value;
    const pwd = document.getElementById('login-pwd').value;
    const msg = document.getElementById('login-msg');

    if (ACCOUNTS[role] && ACCOUNTS[role].pwd === pwd) {
        currentUser = role;
        currentRole = ACCOUNTS[role];
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        applyPermissions();
        initData();
    } else {
        msg.innerText = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥";
    }
}

function applyPermissions() {
    // å°èˆªåˆ—æ§åˆ¶
    const navs = ['A','B','C','D','E','F','G'];
    navs.forEach(p => {
        const el = document.getElementById('nav-'+p);
        if (el) el.style.display = currentRole.pages.includes(p) ? 'block' : 'none';
    });
    // å ±è¡¨çœ¼çƒæ§åˆ¶
    const eyeBtn = document.getElementById('boss-eye-btn');
    if (eyeBtn) eyeBtn.style.display = currentRole.canEye ? 'inline-block' : 'none';
}

function logout() {
    location.reload();
}

async function switchMonth() {
    await initData();
}

async function initData() {
    const mk = document.getElementById('global-month').value;
    
    // 1. è®€å–æ¯æ—¥æ•¸æ“š
    const { data: days } = await db.from('daily_data').select('*').like('date_key', `${mk}-%`);
    currentMonthData = days || [];

    // 2. è®€å–ç³»çµ±è¨­å®š (ç¨ç«‹å­˜æª”: ä¸Šæœˆé¤˜é¡ã€æˆ¿ç§Ÿ)
    const { data: sys } = await db.from('daily_data').select('*').eq('date_key', `SYS-${mk}`).maybeSingle();
    currentSysData = sys || { cash: 0, bank_in: 0, reg_val: 0 }; // cash=ä¸Šæœˆé›¶ç”¨, bank_in=ä¸ŠæœˆéŠ€è¡Œ, reg_val=æˆ¿ç§Ÿ
    
    // 3. æ¸²æŸ“ UI
    renderInputs();
    renderLists();
    calcReport();
}

// --- 3. æ¸²æŸ“é‚è¼¯ (HTML ç”Ÿæˆ) ---
function renderInputs() {
    // å¡«å…¥ Page B/C/E çš„ç¨ç«‹è¨­å®šå€¼
    document.getElementById('prevPetty').value = currentSysData.cash || 0;
    document.getElementById('prevBank').value = currentSysData.bank_in || 0;
    document.getElementById('rentInput').value = currentSysData.reg_val || 0;
}

function renderLists() {
    const mk = document.getElementById('global-month').value;
    const [y, m] = mk.split('-').map(Number);
    const daysInMonth = new Date(y, m, 0).getDate();
    const todayDate = new Date().getDate();

    // é€šç”¨æ¸²æŸ“å‡½æ•¸
    const buildCard = (pageId, day) => {
        // å˜—è©¦æ‰¾è©²æ—¥çš„è³‡æ–™
        const row = currentMonthData.find(r => r.date_key === `${mk}-${String(day).padStart(2,'0')}`) || {};
        const isToday = (day === todayDate && new Date().getMonth()+1 === m);
        const displayStyle = isToday ? 'block' : 'none'; // é è¨­æ”¶æ‘ºï¼Œä»Šå¤©å±•é–‹

        // Page A å…§å®¹
        if (pageId === 'A') {
            const cash = row.cash || 6000; // é è¨­åº•éŒ¢/ç¾é‡‘
            const base = row.base_money || 6000; // é è¨­åº•éŒ¢
            const diff = cash - base; // ç°¡å–®è¨ˆç®—
            // æ­£è² é›¶è®Šè‰²é‚è¼¯
            const diffClass = diff > 0 ? 'diff-positive' : (diff < 0 ? 'diff-negative' : '');
            
            return `
            <div class="row g-2">
                <div class="col-6"><label class="form-label">ç¾é‡‘ç¸½é¡</label><input type="number" id="A-cash-${day}" value="${cash}" class="form-control-mobile" onchange="syncData(${day})"></div>
                <div class="col-6"><label class="form-label">å‚™ç”¨é‡‘(åº•éŒ¢)</label><input type="number" id="A-base-${day}" value="${base}" class="form-control-mobile" onchange="syncData(${day})"></div>
                <div class="col-12 text-end mb-2"><small class="${diffClass}">æœ¬æ—¥ç¾é‡‘å·®ç•°: ${diff}</small></div>
                ${CONFIG.pay.map((p, i) => {
                    const val = (row.pay_vals && row.pay_vals[i]) || 0;
                    return `<div class="col-6"><label class="form-label">${p.name}</label><input type="number" id="A-pay-${day}-${i}" value="${val}" class="form-control-mobile" onchange="syncData(${day})"></div>`;
                }).join('')}
                <div class="col-6"><label class="form-label">å­˜å…¥éŠ€è¡Œ</label><input type="number" id="A-bank-${day}" value="${(row.b_vals && row.b_vals[0]) || 0}" class="form-control-mobile" onchange="syncData(${day})"></div> <div class="col-6"><label class="form-label">æ’¥å…¥é›¶ç”¨</label><input type="number" id="A-petty-${day}" value="${(row.b_vals && row.b_vals[1]) || 0}" class="form-control-mobile" onchange="syncData(${day})"></div> </div>`;
        }
        
        // Page B å…§å®¹
        if (pageId === 'B') {
            return `<div class="row g-2">
                ${CONFIG.catsB.map((c, i) => `
                    <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="B-val-${day}-${i}" value="${(row.b_vals && row.b_vals[i]) || 0}" class="form-control-mobile" onchange="syncData(${day})"></div>
                `).join('')}
            </div>`;
        }

        // Page C å…§å®¹
        if (pageId === 'C') {
            return `<div class="row g-2">
                <div class="col-12"><h6 class="text-white border-bottom pb-1">æ”¶å…¥</h6></div>
                ${CONFIG.catsC_In.map((c, i) => `
                    <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="C-in-${day}-${i}" value="${(row.c_vals && row.c_vals[i]) || 0}" class="form-control-mobile" onchange="syncData(${day})"></div>
                `).join('')}
                <div class="col-12"><h6 class="text-white border-bottom pb-1 mt-2">æ”¯å‡º</h6></div>
                ${CONFIG.catsC_Out.map((c, i) => `
                    <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="C-out-${day}-${i}" value="${(row.d_vals && row.d_vals[i]) || 0}" class="form-control-mobile" onchange="syncData(${day})"></div>
                `).join('')}
            </div>`;
        }

        // Page D å…§å®¹
        if (pageId === 'D') {
            return `<div class="row g-2">
                ${CONFIG.catsD.map((c, i) => `
                    <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="D-val-${day}-${i}" value="${(row.d_vals && row.d_vals[i+10]) || 0}" class="form-control-mobile" onchange="syncData(${day})"></div> `).join('')}
            </div>`;
        }
    };

    // åŸ·è¡Œ HTML ç”Ÿæˆ
    ['A', 'B', 'C', 'D'].forEach(pid => {
        let html = '';
        for (let d = 1; d <= daysInMonth; d++) {
            const isToday = (d === todayDate && new Date().getMonth()+1 === m);
            html += `
            <div class="mobile-card">
                <div class="card-header-date" onclick="toggleCard('box-${pid}-${d}')">
                    <span>${m}/${d}</span>
                    <span>${isToday ? 'ä»Šå¤©' : 'â–¼'}</span>
                </div>
                <div id="box-${pid}-${d}" style="display:${isToday ? 'block' : 'none'}">
                    ${buildCard(pid, d)}
                </div>
            </div>`;
        }
        document.getElementById('list'+pid).innerHTML = html;
    });
}

// --- 4. æ•¸æ“šåŒæ­¥èˆ‡è¨ˆç®— ---
function toggleCard(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === 'none') ? 'block' : 'none';
}

function getVal(id) { return parseFloat(document.getElementById(id)?.value) || 0; }

async function syncData(day) {
    const mk = document.getElementById('global-month').value;
    const dateKey = `${mk}-${String(day).padStart(2,'0')}`;
    
    // æ”¶é›†è©²æ—¥æ‰€æœ‰é é¢æ•¸æ“š (A, B, C, D)
    // æ³¨æ„ï¼šé€™è£¡å°‡æ‰€æœ‰æ•¸æ“šæ‰“åŒ…åˆ°ä¸€å€‹ç‰©ä»¶ï¼ŒSupabase schema éœ€å°æ‡‰
    // Aé 
    const cash = getVal(`A-cash-${day}`);
    const base = getVal(`A-base-${day}`);
    const payVals = CONFIG.pay.map((_, i) => getVal(`A-pay-${day}-${i}`));
    const bankIn = getVal(`A-bank-${day}`); // å€Ÿç”¨ b_vals[0]
    const pettyIn = getVal(`A-petty-${day}`); // å€Ÿç”¨ b_vals[1]

    // Bé  (ç´”b_vals)
    const bVals = CONFIG.catsB.map((_, i) => getVal(`B-val-${day}-${i}`));

    // Cé  (c_vals=æ”¶å…¥, d_vals=æ”¯å‡º å‰åŠæ®µ)
    const cValsIn = CONFIG.catsC_In.map((_, i) => getVal(`C-in-${day}-${i}`));
    const cValsOut = CONFIG.catsC_Out.map((_, i) => getVal(`C-out-${day}-${i}`));

    // Dé  (d_vals å¾ŒåŠæ®µ, ç´¢å¼•åç§» 10)
    const dVals = CONFIG.catsD.map((_, i) => getVal(`D-val-${day}-${i}`));
    
    // çµ„åˆ
    // b_vals çµæ§‹: [Aé å­˜éŠ€, Aé æ’¥é›¶, ...Bé 10é …]
    // d_vals çµæ§‹: [...Cé æ”¯å‡º4é …, 0,0,0,0,0,0, ...Dé 5é …] -> ç‚ºäº†å¡é€²æœ‰é™æ¬„ä½ï¼Œé€™è£¡åšç°¡å–®å°æ‡‰
    
    // ä¿®æ­£ï¼šç‚ºäº†è®“é‚è¼¯æ›´æ¸…æ™°ï¼Œæˆ‘å€‘åœ¨ JS ç«¯è™•ç†å®Œï¼Œå¾Œç«¯åªå­˜å¤§é™£åˆ—
    // å¯¦éš›å­˜æª” Payload
    const payload = {
        date_key: dateKey,
        cash: cash,
        base_money: base,
        pay_vals: payVals, // Aé æ”¯ä»˜
        b_vals: bVals,     // Bé æ”¯å‡º (æ³¨æ„ï¼šAé çš„å­˜éŠ€/æ’¥é›¶å»ºè­°å­˜åœ¨åˆ¥çš„æ¬„ä½ï¼Œæˆ–é€™è£¡æš«å­˜)
                           // ç‚ºäº†ç¬¦åˆåŸéœ€æ±‚ä¸æ›´å‹•DBçµæ§‹å¤ªå¤§ï¼Œé€™è£¡å‡è¨­ b_vals å­˜ Bé 
        c_vals: cValsIn,   // Cé æ”¶å…¥
        d_vals: [...cValsOut, ...new Array(6).fill(0), ...dVals] // Cé æ”¯å‡º(0-3) + Dé é€²è²¨(10-14)
    };

    // æ›´æ–°æœ¬åœ°æ•¸æ“šç·©å­˜
    const idx = currentMonthData.findIndex(r => r.date_key === dateKey);
    if (idx >= 0) currentMonthData[idx] = payload;
    else currentMonthData.push(payload);

    // ä¸Šå‚³ Supabase
    await db.from('daily_data').upsert(payload);
    
    // é‡æ–°è¨ˆç®—å ±è¡¨
    renderLists(); // ç‚ºäº†æ›´æ–°æ­£è² é›¶è®Šè‰² (ä¹Ÿå¯åªæ›´æ–° Class)
    calcReport();
}

async function saveSystemConfig() {
    const mk = document.getElementById('global-month').value;
    const payload = {
        date_key: `SYS-${mk}`,
        cash: getVal('prevPetty'),    // ä¸Šæœˆé›¶ç”¨
        bank_in: getVal('prevBank'),  // ä¸ŠæœˆéŠ€è¡Œ
        reg_val: getVal('rentInput')  // æˆ¿ç§Ÿ
    };
    currentSysData = payload;
    await db.from('daily_data').upsert(payload);
    calcReport();
}

// --- 5. å ±è¡¨é‚è¼¯ (åˆ†é¡åŠ ç¸½) ---
function calcReport() {
    if (currentRole.pages.indexOf('E') === -1) return; // å“¡å·¥ä¸è¨ˆç®—

    let totalRevenue = 0;
    let totalFood = 0;
    let totalAlc = 0;
    let totalHr = 0;
    let totalMisc = 0;
    let totalUtil = 0;

    // éæ­·æ•´æœˆæ•¸æ“š
    currentMonthData.forEach(row => {
        // 1. ç‡Ÿæ”¶ (Aé æ”¯ä»˜ + Cé æ”¶å…¥)
        if (row.pay_vals) {
            row.pay_vals.forEach((v, i) => {
                totalRevenue += (v || 0) * CONFIG.pay[i].fee; // æ‰£æ‰‹çºŒè²»
            });
        }
        if (row.c_vals) {
            row.c_vals.forEach(v => totalRevenue += (v || 0));
        }

        // 2. æ”¯å‡ºåˆ†é¡åŠ ç¸½ (Bé , Cé æ”¯å‡º, Dé )
        // Bé 
        if (row.b_vals) {
            row.b_vals.forEach((v, i) => {
                const type = CONFIG.catsB[i].type;
                if (type === 'food') totalFood += v;
                if (type === 'alc') totalAlc += v;
                if (type === 'hr') totalHr += v;
                if (type === 'misc') totalMisc += v;
                if (type === 'util') totalUtil += v;
            });
        }
        // Cé æ”¯å‡º (d_vals å‰4é …)
        if (row.d_vals) {
            CONFIG.catsC_Out.forEach((c, i) => {
                const v = row.d_vals[i] || 0;
                const type = c.type;
                if (type === 'food') totalFood += v;
                if (type === 'alc') totalAlc += v;
                if (type === 'hr') totalHr += v;
                if (type === 'misc') totalMisc += v;
            });
            // Dé é€²è²¨ (d_vals 10-14é …)
            CONFIG.catsD.forEach((c, i) => {
                const v = row.d_vals[i+10] || 0;
                const type = c.type;
                if (type === 'food') totalFood += v;
                if (type === 'alc') totalAlc += v;
                if (type === 'misc') totalMisc += v;
            });
        }
    });

    const rent = currentSysData.reg_val || 0;
    const totalExp = totalFood + totalAlc + totalHr + totalMisc + totalUtil + rent;
    const netProfit = totalRevenue - totalExp;

    // æ¸²æŸ“å ±è¡¨
    const html = `
        <div class="row g-3 text-white">
            <div class="col-6"><span class="text-muted">ç¸½æ·¨ç‡Ÿæ”¶</span><br><h4 class="secret-val text-warning">${Math.round(totalRevenue)}</h4></div>
            <div class="col-6"><span class="text-muted">ç¸½æ”¯å‡º</span><br><h4 class="secret-val">${Math.round(totalExp)}</h4></div>
            <div class="col-12"><hr></div>
            <div class="col-4"><small>é£Ÿææˆæœ¬</small><br><span class="secret-val">${totalFood}</span></div>
            <div class="col-4"><small>é…’æ°´æˆæœ¬</small><br><span class="secret-val">${totalAlc}</span></div>
            <div class="col-4"><small>äººäº‹è²»ç”¨</small><br><span class="secret-val">${totalHr}</span></div>
            <div class="col-4"><small>æ°´é›»é›œæ”¯</small><br><span class="secret-val">${totalMisc + totalUtil}</span></div>
            <div class="col-4"><small>æˆ¿ç§Ÿ</small><br><span class="secret-val">${rent}</span></div>
            <div class="col-12 mt-3 p-2 border border-info rounded">
                <span class="text-info">æœ¬æœˆé ä¼°æ·¨åˆ©</span><br>
                <h2 class="secret-val" style="color:var(--hint);">${Math.round(netProfit)}</h2>
            </div>
        </div>
    `;
    document.getElementById('report-content').innerHTML = html;
}

function toggleBossMode() {
    const el = document.getElementById('report-content');
    el.classList.toggle('boss-blur');
}

function navTo(page) {
    document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('page'+page).classList.add('active');
    document.getElementById('nav-'+page).classList.add('active');
}
</script>
</body>
</html>
