<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026 åº—å‹™ç³»çµ± - æ¬Šé™ç®¡ç†æ——è‰¦ç‰ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { 
      --bg-color: #121212; --text-color: #ffffff; --accent-color: #bb86fc;
      --card-bg: rgba(255,255,255,0.08); --input-bg: rgba(255,255,255,0.12);
      --hint: #03dac6; --danger: #ff5252; --nav-bg: rgba(0,0,0,0.95);
    }
    body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; padding-bottom: 90px; transition: 0.3s; }
    .light-theme { --bg-color: #f8f9fa; --text-color: #212529; --accent-color: #6200ee; --card-bg: #ffffff; --input-bg: #e9ecef; --nav-bg: #fff; }
    
    /* ç™»å…¥é®ç½© */
    #login-overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    
    /* å¡ç‰‡èˆ‡è¼¸å…¥æ¡†æ¨£å¼ */
    .mobile-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin: 10px 15px; border-left: 4px solid var(--accent-color); position: relative; }
    .card-date { font-weight: bold; color: var(--accent-color); display: flex; justify-content: space-between; cursor: pointer; align-items: center; }
    .form-label { font-size: 0.85rem; color: #bbb; margin-bottom: 4px; font-weight: bold; display: block; }
    .light-theme .form-label { color: #555; }
    .form-control-mobile { background: var(--input-bg) !important; border: 1px solid #555 !important; color: var(--text-color) !important; border-radius: 6px; padding: 8px; font-size: 1rem; width: 100%; }
    .light-theme .form-control-mobile { border: 1px solid #ccc !important; }

    /* åº•éƒ¨å°èˆª */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
    .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 0.75rem; flex: 1; cursor: pointer; transition: 0.2s; }
    .nav-item.active { color: var(--accent-color); font-weight: bold; transform: scale(1.1); }
    .nav-item i { display: block; font-size: 1.3rem; font-style: normal; margin-bottom: 2px; }

    /* é é¢åˆ‡æ› */
    .page-content { display: none; padding-top: 10px; animation: fadeIn 0.3s; }
    .page-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ç‰¹æ®Šæ¨™ç±¤èˆ‡ç‹€æ…‹ */
    .sync-status { position: fixed; top: 10px; right: 10px; padding: 4px 12px; border-radius: 20px; font-size: 12px; z-index: 10001; font-weight: bold; }
    .boss-mode-blur .report-val { filter: blur(10px); transition: 0.3s; }
    .today-tag { background: var(--hint); color: #000; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: bold; }
    .month-selector { background: var(--card-bg); margin: 0 15px 15px 15px; padding: 12px; border-radius: 12px; border: 1px solid var(--accent-color); display: flex; align-items: center; justify-content: space-between; }
    
    .btn-del-item { font-size: 0.8rem; color: var(--danger); border: 1px solid var(--danger); background: transparent; border-radius: 5px; padding: 2px 8px; }
  </style>
</head>
<body>

<div id="sync-indicator" class="sync-status text-white" style="display:none; background: var(--hint);"></div>

<div id="login-overlay">
  <div class="p-4 w-100" style="max-width: 350px;">
    <h3 class="text-center mb-4" style="color: var(--accent-color);">2026 åº—å‹™ç³»çµ±</h3>
    <div class="mb-3">
        <label class="form-label">ä½¿ç”¨è€…è§’è‰²</label>
        <select id="user-select" class="form-select form-control-mobile"></select>
    </div>
    <div class="mb-4">
        <label class="form-label">ç™»å…¥å¯†ç¢¼</label>
        <input type="password" id="login-pwd" class="form-control-mobile" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    </div>
    <button class="btn btn-primary w-100 py-3 fw-bold" onclick="authLogin()" style="background:var(--accent-color); border:none; color:#000;">é€²å…¥ç³»çµ±</button>
    <div class="text-center mt-3">
        <small class="text-muted" id="login-status">ç³»çµ±å°±ç·’</small>
    </div>
  </div>
</div>

<div id="app" style="display:none;">
  
  <div id="pageA" class="page-content active">
    <div class="month-selector">
        <span style="font-weight:bold;">ğŸ“… é¸æ“‡æœˆä»½</span>
        <input type="month" id="global-month" class="form-control-mobile" style="width: 150px;" onchange="changeMonth()">
    </div>
    <h5 class="text-center mb-3">A. æ¯æ—¥ç‡Ÿæ”¶</h5>
    <div id="listA"></div>
  </div>

  <div id="pageB" class="page-content">
    <h5 class="text-center mb-3">B. é›¶ç”¨é‡‘æ”¯å‡º</h5>
    <div class="mobile-card" id="view-prevPetty">
        <label class="form-label">ä¸Šæœˆé›¶ç”¨é¤˜é¡:</label> 
        <input type="number" id="prevPetty" class="form-control-mobile" placeholder="è«‹è¼¸å…¥é‡‘é¡" onchange="saveSystem()">
    </div>
    <div id="listB"></div>
  </div>

  <div id="pageC" class="page-content">
    <h5 class="text-center mb-3">C. éŠ€è¡Œæ”¶æ”¯</h5>
    <div class="mobile-card" id="view-prevBank">
        <label class="form-label">ä¸ŠæœˆéŠ€è¡Œé¤˜é¡:</label> 
        <input type="number" id="prevBank" class="form-control-mobile" placeholder="è«‹è¼¸å…¥é‡‘é¡" onchange="saveSystem()">
    </div>
    <div id="listC"></div>
  </div>

  <div id="pageD" class="page-content">
    <h5 class="text-center mb-3">D. å» å•†æœˆçµé€²è²¨</h5>
    <div id="listD"></div>
  </div>

  <div id="pageE" class="page-content">
    <h5 class="text-center mb-3">
        E. æœˆåº¦æç›Šå ±è¡¨ 
        <button id="boss-eye-btn" class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleBossMode()">ğŸ‘ï¸</button>
    </h5>
    <div class="mobile-card" id="view-rent">
        <label class="form-label">æˆ¿ç§Ÿæ”¯å‡º:</label> 
        <input type="number" id="rentInput" class="form-control-mobile" placeholder="è«‹è¼¸å…¥æˆ¿ç§Ÿ" onchange="saveSystem()">
    </div>
    <div id="reportArea"></div>
  </div>

  <div id="pageF" class="page-content">
    <h5 class="text-center text-danger">F. å¾Œå°ç³»çµ±è¨­å®š</h5>
    <div class="px-3">
        <div class="mobile-card">
            <h6>1. ä¸»é¡Œé…è‰²</h6>
            <div class="d-flex gap-2 mb-2">
                <button class="btn btn-sm btn-dark flex-fill" onclick="setTheme('dark')">æ·±è‰²æ¨¡å¼</button>
                <button class="btn btn-sm btn-light flex-fill" onclick="setTheme('light')">æ·ºè‰²æ¨¡å¼</button>
            </div>
            <label class="form-label">è‡ªå®šç¾©é‡é»è‰²</label>
            <input type="color" id="accentColorPicker" class="form-control mb-2" onchange="setAccent(this.value)">
        </div>
        <div class="mobile-card">
            <h6>2. æ”¯ä»˜æ‰‹çºŒè²»è¨­å®š</h6>
            <div id="cfg-list-pay"></div>
            <button class="btn btn-sm btn-warning w-100 mt-2" onclick="saveFullConfig()">å„²å­˜æ”¯ä»˜è¨­å®š</button>
        </div>
    </div>
  </div>

  <div id="pageG" class="page-content">
    <h5 class="text-center text-danger">G. æ¬Šé™å¸³è™Ÿç®¡ç†</h5>
    <div class="px-3">
        <div id="user-manage-list"></div>
        <div class="mobile-card mt-3">
            <h6>æ–°å¢å¸³è™Ÿ</h6>
            <input type="text" id="new-u-name" class="form-control-mobile mb-2" placeholder="å¸³è™Ÿåç¨±">
            <input type="password" id="new-u-pwd" class="form-control-mobile mb-2" placeholder="ç™»å…¥å¯†ç¢¼">
            <select id="new-u-role" class="form-control-mobile mb-3">
                <option value="manager">åº—é•· (å¯çœ‹å ±è¡¨, ç„¡å¾Œå°)</option>
                <option value="staff">å“¡å·¥ (åƒ…é™è¼¸å…¥)</option>
            </select>
            <button class="btn btn-success w-100 fw-bold" onclick="addUser()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showPage('A')" id="nav-A"><i>ğŸ“Š</i>ç‡Ÿæ”¶</div>
    <div class="nav-item" onclick="showPage('B')" id="nav-B"><i>ğŸ’¸</i>æ”¯å‡º</div>
    <div class="nav-item" onclick="showPage('C')" id="nav-C"><i>ğŸ¦</i>éŠ€è¡Œ</div>
    <div class="nav-item" onclick="showPage('D')" id="nav-D"><i>ğŸšš</i>é€²è²¨</div>
    <div class="nav-item" onclick="showPage('E')" id="nav-E"><i>ğŸ“ˆ</i>å ±è¡¨</div>
    <div class="nav-item" onclick="showPage('F')" id="nav-F" style="display:none;"><i>âš™ï¸</i>å¾Œå°</div>
    <div class="nav-item" onclick="showPage('G')" id="nav-G" style="display:none;"><i>ğŸ‘¤</i>æ¬Šé™</div>
  </nav>
</div>

// --- [é‡é»] æ ¸å¿ƒå›ºå®šé …ç›®èˆ‡é‚è¼¯ï¼šåš´ç¦åˆªæ¸› ---
const DEFAULT_CONFIG = {
    theme: 'dark', 
    accent: '#bb86fc',
    pay: [
        {name:'ä¿¡ç”¨å¡', pct:0.98}, 
        {name:'å…¨æ”¯ä»˜', pct:0.98}, 
        {name:'UBER', pct:0.65}
    ],
    catsB: [
        {name:'é£Ÿå“æ”¯å‡º', type:'food'}, {name:'é…’é¡æ”¯å‡º', type:'alc'}, 
        {name:'å¤–å¸¶é¤ç›’', type:'misc'}, {name:'å…¶é¤˜é›œæ”¯', type:'misc'},
        {name:'å‹å¥ä¿', type:'hr'}, {name:'PT', type:'hr'}, 
        {name:'é›»ä¿¡', type:'misc'}, {name:'é›»è²»', type:'misc'}, 
        {name:'æ°´è²»', type:'misc'}, {name:'ç“¦æ–¯', type:'misc'}
    ],
    catsC: [
        {name:'å…¨æ”¯ä»˜æ”¶å…¥', type:'income'}, {name:'ä¿¡ç”¨å¡æ”¶å…¥', type:'income'}, 
        {name:'UBERæ”¶å…¥', type:'income'}, {name:'å…¶é¤˜æ”¶å…¥', type:'income'},
        {name:'é£Ÿå“æ”¯å‡º', type:'food'}, {name:'é…’é¡æ”¯å‡º', type:'alc'}, 
        {name:'é›œæ”¯æ¬¾', type:'misc'}, {name:'äººäº‹æ¬¾', type:'hr'}
    ],
    catsD: [
        {name:'èœå•†', type:'food'}, {name:'æµ·é®®å•†', type:'food'}, 
        {name:'è‚‰å•†', type:'food'}, {name:'é…’å•†', type:'alc'}, 
        {name:'é›œè²¨å•†', type:'misc'}
    ]
};

// ã€é‡è¦ã€‘ç¢ºä¿é€™è£¡ç›´æ¥å®šç¾©å¥½ï¼Œä¸è¦åœ¨ onload è£¡é¢ç”¨ users = [...] è¦†è“‹
let users = [
    {user:'è€é—†', pwd:'1234', role:'boss'},
    {user:'åº—é•·', pwd:'5678', role:'manager'},
    {user:'å“¡å·¥', pwd:'0000', role:'staff'}
];

let sysConfig = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
let currentUser = null;

const SB_URL = "https://jxtjkjexnqfhxmwfgcgl.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4dGpramV4bnFmaHhtd2ZnY2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTA4ODEsImV4cCI6MjA4NjM2Njg4MX0.Ebw_qhA3Z_p_tB_EwxWmvC0z3oC9MisDQm6DEuGkno0";
const db = supabase.createClient(SB_URL, SB_KEY);

// ä¿®æ­£å¾Œçš„å•Ÿå‹•é †åº
window.onload = async () => {
    // 1. è¨­å®šæ—¥æœŸ
    const now = new Date();
    const dateEl = document.getElementById('global-month');
    if(dateEl) dateEl.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    
    // 2. ç«‹å³é¡¯ç¤ºé è¨­å¸³è™Ÿ (é€™æ­¥è§£æ±ºä½ çš„é¸å–®ç©ºç™½å•é¡Œ)
    renderUserSelect(); 

    // 3. å˜—è©¦è¼‰å…¥è³‡æ–™åº«è³‡æ–™
    try {
        await Promise.all([loadConfig(), loadUsers()]);
    } catch(e) { 
        console.error("åˆå§‹åŒ–è³‡æ–™å¤±æ•—", e); 
    }
    
    // 4. å…¨éƒ¨è¼‰å…¥å¾Œå†æ¬¡åˆ·æ–° UI
    renderUserSelect();
    updateTheme();
};

// --- ç™»å…¥èˆ‡æ¬Šé™ç®¡ç† ---
function renderUserSelect() {
    const sel = document.getElementById('user-select');
    sel.innerHTML = users.map(u => `<option value="${u.user}">${u.user}</option>`).join('');
}

function authLogin() {
    const u = document.getElementById('user-select').value;
    const p = document.getElementById('login-pwd').value;
    const found = users.find(x => x.user === u && x.pwd === p);
    
    if(found) {
        currentUser = found;
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        // åŸ·è¡Œæ¬Šé™é–å®š
        applyPermissions();
        initApp();

        // å“¡å·¥å¼·è¡Œé‡å°å‘åˆ° A é 
        if (currentUser.role === 'staff') showPage('A');
    } else {
        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
    }
}

function applyPermissions() {
    if (!currentUser) return;
    const role = currentUser.role;
    const user = currentUser.user;

    const navE = document.getElementById('nav-E'); // å ±è¡¨
    const navF = document.getElementById('nav-F'); // å¾Œå°
    const navG = document.getElementById('nav-G'); // æ¬Šé™
    const eyeBtn = document.getElementById('boss-eye-btn'); // çœ¼ç›

    // 1. å…ˆå…¨éƒ¨éš±è—
    [navE, navF, navG].forEach(n => n.style.display = 'none');
    if(eyeBtn) eyeBtn.style.display = 'none';

    // 2. æ ¹æ“šè§’è‰²é–‹æ”¾
    if (user === 'è€é—†' || role === 'boss') {
        navE.style.display = 'block';
        navF.style.display = 'block';
        navG.style.display = 'block';
        if(eyeBtn) eyeBtn.style.display = 'inline-block';
    } 
    else if (role === 'manager') {
        navE.style.display = 'block'; // åº—é•·çœ‹å¾—åˆ°å ±è¡¨
        if(eyeBtn) eyeBtn.style.display = 'inline-block'; // åº—é•·çœ‹å¾—åˆ°çœ¼ç›
    } 
    // å“¡å·¥ role === 'staff' æœƒç¶­æŒå…¨éƒ¨éš±è—ç‹€æ…‹
}

// --- é é¢æ¸²æŸ“é‚è¼¯ (å…¨é‡å±•é–‹) ---
function initApp() { renderPages(); loadDailyData(); }
function changeMonth() { renderPages(); loadDailyData(); }

function renderPages() {
    const monthStr = document.getElementById('global-month').value;
    const [y, m] = monthStr.split('-').map(Number);
    const daysInMonth = new Date(y, m, 0).getDate();
    const today = new Date();
    const isTodayMonth = (y === today.getFullYear() && m === (today.getMonth() + 1));

    const build = (id, title, fn) => {
        let html = '';
        for(let d = 1; d <= daysInMonth; d++) {
            const isToday = (isTodayMonth && d === today.getDate());
            html += `
            <div class="mobile-card">
                <div class="card-date" onclick="toggle('${id}',${d})">
                    <span>${m}/${d} ${title} ${isToday ? '<span class="today-tag">ä»Šæ—¥</span>' : ''}</span>
                    <span id="arr-${id}-${d}">${isToday ? 'â–²' : 'â–¼'}</span>
                </div>
                <div id="box-${id}-${d}" style="display:${isToday ? 'block' : 'none'}; margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    ${fn(d)}
                </div>
            </div>`;
        }
        document.getElementById('list' + id).innerHTML = html;
    };

    // A é é¢çµæ§‹
    build('A', 'ç‡Ÿæ”¶', (d) => `
        <div class="row g-2">
            <div class="col-6"><label class="form-label">ç¾é‡‘ (æ‰‹é»)</label><input type="number" id="cash-${d}" class="form-control-mobile" value="6000" onchange="sync(${d})"></div>
            <div class="col-6"><label class="form-label">åº•éŒ¢</label><input type="number" id="reg-${d}" class="form-control-mobile" value="6000" onchange="sync(${d})"></div>
            ${sysConfig.pay.map((p, i) => `
                <div class="col-4"><label class="form-label">${p.name}</label><input type="number" id="pay-${i}-${d}" class="form-control-mobile" onchange="sync(${d})"></div>
            `).join('')}
            <div class="col-6"><label class="form-label text-warning">é…’æ°´ç‡Ÿæ”¶ (å°è¨ˆ)</label><input type="number" id="alc-${d}" class="form-control-mobile" onchange="sync(${d})"></div>
            <div class="col-3"><label class="form-label">å…¥éŠ€è¡Œ</label><input type="number" id="abank-${d}" class="form-control-mobile" onchange="sync(${d})"></div>
            <div class="col-3"><label class="form-label">å…¥é›¶ç”¨</label><input type="number" id="apetty-${d}" class="form-control-mobile" onchange="sync(${d})"></div>
            <div class="col-12 text-end mt-2"><small>æ­£è² é›¶ï¼š</small><b id="diff-${d}">0</b></div>
        </div>
    `);

    // B é é¢çµæ§‹
    build('B', 'é›¶ç”¨æ”¯å‡º', (d) => `
        <div class="row g-2">
            ${sysConfig.catsB.map((c, i) => `
                <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="b-v-${d}-${i}" class="form-control-mobile" onchange="sync(${d})"></div>
            `).join('')}
        </div>
    `);

    // C é é¢çµæ§‹
    build('C', 'éŠ€è¡Œæ”¶æ”¯', (d) => `
        <div class="row g-2">
            ${sysConfig.catsC.map((c, i) => `
                <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="c-v-${d}-${i}" class="form-control-mobile" onchange="sync(${d})"></div>
            `).join('')}
        </div>
    `);

    // D é é¢çµæ§‹
    build('D', 'é€²è²¨é€²é …', (d) => `
        <div class="row g-2">
            ${sysConfig.catsD.map((c, i) => `
                <div class="col-6"><label class="form-label">${c.name}</label><input type="number" id="d-v-${d}-${i}" class="form-control-mobile" onchange="sync(${d})"></div>
            `).join('')}
        </div>
    `);
}

// --- è³‡æ–™åº«åŒæ­¥èˆ‡è¨ˆç®— (å…¨é‡å±•é–‹) ---
async function sync(d) {
    const mk = document.getElementById('global-month').value;
    const ind = document.getElementById('sync-indicator');
    ind.style.display = 'block'; ind.innerText = "â³ å„²å­˜ä¸­...";

    const data = {
        date_key: `${mk}-${d.toString().padStart(2, '0')}`,
        cash: val(`cash-${d}`),
        reg_val: val(`reg-${d}`),
        alc_val: val(`alc-${d}`),
        bank_in: val(`abank-${d}`),
        petty_in: val(`apetty-${d}`),
        pay_vals: sysConfig.pay.map((_, i) => val(`pay-${i}-${d}`)),
        b_vals: sysConfig.catsB.map((_, i) => val(`b-v-${d}-${i}`)),
        c_vals: sysConfig.catsC.map((_, i) => val(`c-v-${d}-${i}`)),
        d_vals: sysConfig.catsD.map((_, i) => val(`d-v-${d}-${i}`))
    };

    try {
        await db.from('daily_data').upsert(data);
        ind.innerText = "âœ“ å·²å„²å­˜";
        setTimeout(() => ind.style.display = 'none', 1000);
        calcAll();
    } catch (e) {
        ind.innerText = "âŒ å„²å­˜å¤±æ•—";
        console.error(e);
    }
}

async function loadDailyData() {
    const mk = document.getElementById('global-month').value;
    const { data } = await db.from('daily_data').select('*').like('date_key', `${mk}%`);
    
    if (data) {
        data.forEach(row => {
            const d = parseInt(row.date_key.split('-')[2]);
            if (!document.getElementById(`cash-${d}`)) return;
            
            document.getElementById(`cash-${d}`).value = row.cash;
            document.getElementById(`reg-${d}`).value = row.reg_val;
            document.getElementById(`alc-${d}`).value = row.alc_val;
            document.getElementById(`abank-${d}`).value = row.bank_in;
            document.getElementById(`apetty-${d}`).value = row.petty_in;
            
            const fill = (p, v) => { if (v && Array.isArray(v)) v.forEach((val, i) => { const el = document.getElementById(`${p}-${d}-${i}`); if (el) el.value = val; }); };
            fill('pay', row.pay_vals);
            fill('b-v', row.b_vals);
            fill('c-v', row.c_vals);
            fill('d-v', row.d_vals);
        });
    }

    // è¼‰å…¥è©²æœˆä»½ç¨ç«‹çš„é¤˜é¡èˆ‡æˆ¿ç§Ÿ
    const sys = await db.from('daily_data').select('*').eq('date_key', `SYS-${mk}`).maybeSingle();
    if (sys.data) {
        document.getElementById('prevPetty').value = sys.data.cash || 0;
        document.getElementById('prevBank').value = sys.data.bank_in || 0;
        document.getElementById('rentInput').value = sys.data.reg_val || 0;
    } else {
        document.getElementById('prevPetty').value = 0;
        document.getElementById('prevBank').value = 0;
        document.getElementById('rentInput').value = 0;
    }
    calcAll();
}

async function saveSystem() {
    const mk = document.getElementById('global-month').value;
    await db.from('daily_data').upsert({ 
        date_key: `SYS-${mk}`, 
        cash: val('prevPetty'), 
        bank_in: val('prevBank'), 
        reg_val: val('rentInput') 
    });
    calcAll();
}

function calcAll() {
    const monthStr = document.getElementById('global-month').value;
    const days = new Date(monthStr.split('-')[0], monthStr.split('-')[1], 0).getDate();
    
    let tRev = 0, tAlcRev = 0, costF = 0, costA = 0, costM = 0, costHR = 0;
    
    for (let d = 1; d <= days; d++) {
        // A é æ­£è² é›¶èˆ‡ç‡Ÿæ”¶
        let dPayNet = 0; 
        sysConfig.pay.forEach((p, i) => dPayNet += (val(`pay-${i}-${d}`) * p.pct));
        
        const cashIn = val(`cash-${d}`) - val(`reg-${d}`);
        tRev += (cashIn + dPayNet);
        tAlcRev += val(`alc-${d}`);

        const diff = Math.round(cashIn - (val(`abank-${d}`) + val(`apetty-${d}`)));
        const de = document.getElementById(`diff-${d}`);
        if (de) {
            de.innerText = diff;
            de.style.color = (diff === 0) ? 'var(--hint)' : 'var(--danger)';
        }

        // B/C/D æ”¯å‡ºåŠ ç¸½
        const sum = (prefix, config) => config.forEach((c, i) => {
            const v = val(`${prefix}-${d}-${i}`);
            if (c.type === 'food') costF += v;
            else if (c.type === 'alc') costA += v;
            else if (c.type === 'hr') costHR += v;
            else if (c.type === 'misc') costM += v;
        });
        sum('b-v', sysConfig.catsB);
        sum('c-v', sysConfig.catsC);
        sum('d-v', sysConfig.catsD);
    }

    const rent = val('rentInput');
    const totalExp = costF + costA + costM + costHR + rent;
    const netProfit = tRev - totalExp;

    document.getElementById('reportArea').innerHTML = `
        <div class="row g-2 boss-mode-blur mt-2">
            <div class="col-12">
                <div class="mobile-card text-center" style="background:var(--accent-color); color:#000;">
                    <h6 class="mb-1">æœ¬æœˆé ä¼°ç´”åˆ©</h6>
                    <h2 class="report-val fw-bold">${Math.round(netProfit).toLocaleString()}</h2>
                </div>
            </div>
            <div class="col-6"><div class="mobile-card">ç¸½ç‡Ÿæ”¶<br><b class="report-val">${Math.round(tRev).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">ç¸½æ”¯å‡º<br><b class="report-val text-danger">${Math.round(totalExp).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é£Ÿæè²»<br><small>${((costF/tRev)*100||0).toFixed(1)}%</small><br><b class="report-val">${Math.round(costF).toLocaleString()}</b></div></div>
            <div class="col-6"><div class="mobile-card">é…’æ°´è²»<br><small>${((costA/tRev)*100||0).toFixed(1)}%</small><br><b class="report-val">${Math.round(costA).toLocaleString()}</b></div></div>
        </div>
    `;
}

// --- ä»‹é¢å·¥å…·åŠŸèƒ½ ---
function val(id) { return parseFloat(document.getElementById(id)?.value) || 0; }
function toggle(id, d) {
    const e = document.getElementById(`box-${id}-${d}`);
    const a = document.getElementById(`arr-${id}-${d}`);
    const isHidden = e.style.display === 'none';
    e.style.display = isHidden ? 'block' : 'none';
    a.innerText = isHidden ? 'â–²' : 'â–¼';
}

function showPage(p) {
    document.querySelectorAll('.page-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    document.getElementById('page' + p).classList.add('active');
    document.getElementById('nav-' + p).classList.add('active');
}

function toggleBossMode() {
    document.getElementById('reportArea').classList.toggle('boss-mode-blur');
}

function setTheme(t) {
    sysConfig.theme = t;
    document.body.className = (t === 'light' ? 'light-theme' : '');
}

function setAccent(c) {
    sysConfig.accent = c;
    document.documentElement.style.setProperty('--accent-color', c);
}

// --- è¨­å®šæª”èˆ‡å¸³è™Ÿå­˜å– ---
async function loadConfig() {
    const { data } = await db.from('daily_data').select('*').eq('date_key', 'CONFIG').maybeSingle();
    if (data) {
        sysConfig = JSON.parse(data.memo_text);
        renderConfigUI();
    }
}

function renderConfigUI() {
    const box = document.getElementById('cfg-list-pay');
    box.innerHTML = sysConfig.pay.map((p, i) => `
        <div class="d-flex gap-2 mb-2">
            <input type="text" class="form-control-mobile" value="${p.name}" readonly>
            <input type="number" step="0.01" class="form-control-mobile" value="${p.pct}" onchange="sysConfig.pay[${i}].pct=parseFloat(this.value)">
        </div>
    `).join('');
}

async function saveFullConfig() {
    await db.from('daily_data').upsert({ date_key: 'CONFIG', memo_text: JSON.stringify(sysConfig) });
    alert("è¨­å®šå·²å„²å­˜ï¼");
}

async function loadUsers() {
    try {
        const { data } = await db.from('daily_data').select('*').eq('date_key', 'USERS').maybeSingle();
        // å¦‚æœè³‡æ–™åº«æœ‰æ±è¥¿ï¼Œæ‰è¦†è“‹é è¨­å€¼ï¼›æ²’æ±è¥¿å°±ç¶­æŒé è¨­çš„ä¸‰å€‹å¸³è™Ÿ
        if (data && data.memo_text) {
            users = JSON.parse(data.memo_text);
        }
    } catch(e) { console.error("è³‡æ–™åº«å¸³è™Ÿè¼‰å…¥å¤±æ•—"); }
    renderUserSelect(); 
    renderUserUI();
}

function renderUserUI() {
    document.getElementById('user-manage-list').innerHTML = users.map((u, i) => `
        <div class="mobile-card d-flex justify-content-between align-items-center">
            <div><b>${u.user}</b> <small>(${u.role})</small></div>
            ${u.user !== 'è€é—†' ? `<button class="btn-del-item" onclick="delUser(${i})">âœ• åˆªé™¤</button>` : ''}
        </div>
    `).join('');
}

async function addUser() {
    const n = document.getElementById('new-u-name').value;
    const p = document.getElementById('new-u-pwd').value;
    const r = document.getElementById('new-u-role').value;
    if (n && p) {
        users.push({ user: n, pwd: p, role: r });
        await db.from('daily_data').upsert({ date_key: 'USERS', memo_text: JSON.stringify(users) });
        renderUserUI();
        renderUserSelect();
        alert("æ–°å¢æˆåŠŸï¼");
    }
}

async function delUser(i) {
    if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿå—ï¼Ÿ")) {
        users.splice(i, 1);
        await db.from('daily_data').upsert({ date_key: 'USERS', memo_text: JSON.stringify(users) });
        renderUserUI();
        renderUserSelect();
    }
}

function updateTheme() {
    setTheme(sysConfig.theme);
    setAccent(sysConfig.accent);
}
</script>
</body>
</html>


